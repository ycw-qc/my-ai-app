<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é†«è€…æœ‰è€†app+</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CareAssist">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom styles for accessibility and large touch targets */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --btn-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            padding-bottom: 120px; /* Space for tab bar */
            font-size: 18px;
            /* Prevent pull-to-refresh on mobile for app-like feel */
            overscroll-behavior-y: none;
        }
        .container {
            max-width: 768px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
        }
        
        /* Scrollable Tab Bar */
        .tab-bar {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            gap: 0.5rem;
            padding: 1rem;
            background: white;
            border-radius: 2rem 2rem 0 0;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.15);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            justify-content: space-around;
            max-width: 768px;
            margin: 0 auto;
            border-top: 4px solid #e2e8f0;
        }
        .tab-button {
            padding: 0.5rem 0;
            width: 100%;
            font-size: 0.9rem;
            font-weight: 800;
            transition: all 0.2s;
            border-radius: 1rem;
            color: #94a3b8;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            border: none;
        }
        .tab-button i {
            font-size: 2rem; 
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }
        .tab-button.active {
            color: #4f46e5;
            transform: translateY(-5px);
        }

        /* Views Animation */
        .view-section {
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        .view-section.active {
            display: block;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            background-color: white;
            padding: 2rem;
            border-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            border: 1px solid #f1f5f9;
        }
        
        /* Inputs & Buttons */
        input[type="text"], input[type="date"], input[type="tel"], input[type="time"], input[type="password"], button:not(.tab-button):not(.menu-item), textarea, select {
            min-height: 4.5rem;
            font-size: 1.3rem;
            border-radius: 1rem;
            border: 3px solid #cbd5e1;
            padding: 0.75rem 1.25rem;
            width: 100%;
            margin-bottom: 1.25rem;
            background-color: #f8fafc;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4f46e5;
            background-color: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }

        /* Youtube-style Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
            height: 24px; /* Larger touch area */
            margin: 0;
            position: relative;
            z-index: 10;
        }
        /* Track */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
        }
        /* Thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #ff0000; /* Youtube Red */
            margin-top: -7px; /* center on track */
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            border: 2px solid white;
        }
        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.4);
            box-shadow: 0 0 0 8px rgba(255, 0, 0, 0.1);
        }
        /* Firefox styles */
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #ff0000;
            border: 2px solid white;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-weight: 700;
            box-shadow: var(--btn-shadow);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.97); }
        
        .btn-secondary {
            background-color: white;
            color: #334155;
            border: 3px solid #cbd5e1;
            font-weight: 700;
        }
        
        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
        }
        /* Changed from div to button for better click handling */
        button.menu-item {
            padding: 2rem 1rem;
            border-radius: 2rem;
            text-align: center;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.15); 
            transition: transform 0.2s;
            cursor: pointer;
            border-width: 0px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 0.5rem;
            width: 100%;
            appearance: none;
        }
        button.menu-item:active { transform: scale(0.95); }
        .menu-icon {
            font-size: 4.5rem;
            margin-bottom: 0.5rem;
            display: block;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); 
        }
        
        /* Video */
        #video-container {
            position: relative;
            border-radius: 2rem;
            overflow: hidden;
            background: black;
            margin-bottom: 1.5rem;
            border: 4px solid #334155;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        #video-feed { width: 100%; height: auto; display: block; }
        .scan-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 60%; border: 4px dashed rgba(255,255,255,0.9);
            border-radius: 1.5rem; pointer-events: none; box-shadow: 0 0 0 999px rgba(0,0,0,0.6);
            transition: border-color 0.3s;
        }
        .instruction-badge {
            position: absolute; top: 1rem; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1.5rem;
            border-radius: 999px; font-weight: bold; font-size: 1.1rem;
            border: 2px solid white; pointer-events: none;
        }
        
        /* Category Badge Styles */
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 800;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        /* Utility */
        h2 { font-size: 2rem !important; color: #1e293b; }
        label { font-size: 1.1rem !important; color: #475569; margin-bottom: 0.5rem; display: block; }
        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1); width: 48px; height: 48px; border-radius: 50%;
            border-left-color: #4f46e5; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-500 to-purple-600 p-8 rounded-b-3xl shadow-lg mb-6 flex justify-between items-center sticky top-0 z-40">
        <div>
            <h1 class="text-3xl font-extrabold text-white tracking-wide">é†«è€…æœ‰è€†app+</h1>
            <p id="user-id-display" class="text-base text-indigo-100 font-medium opacity-80 mt-1">é€£ç·šä¸­...</p>
        </div>
    </header>

    <div class="container mx-auto pb-32">
        
        <!-- VIEW: MENU (HOME) -->
        <div id="view-menu" class="view-section active">
            <div class="menu-grid">
                <button onclick="switchTab('medicine')" class="menu-item bg-red-600 text-white col-span-2 shadow-red-200">
                    <i class="fas fa-capsules menu-icon text-white/90"></i>
                    <span class="font-extrabold text-3xl">è—¥ç‰©è¾¨è­˜</span>
                </button>
                <button onclick="switchTab('notes')" class="menu-item bg-amber-500 text-white shadow-amber-200">
                    <i class="fas fa-microphone-alt menu-icon text-white/90"></i>
                    <span class="font-extrabold text-3xl">èªéŸ³ç­†è¨˜</span>
                </button>
                <button onclick="switchTab('transport')" class="menu-item bg-teal-600 text-white shadow-teal-200">
                    <i class="fas fa-bus menu-icon text-white/90"></i>
                    <span class="font-extrabold text-3xl">äº¤é€šåŠçš„å£«</span>
                </button>
                <button onclick="switchTab('contacts')" class="menu-item bg-blue-600 text-white shadow-blue-200">
                    <i class="fas fa-address-book menu-icon text-white/90"></i>
                    <span class="font-extrabold text-3xl">è¯çµ¡äºº</span>
                </button>
                <button onclick="switchTab('reminders')" class="menu-item bg-indigo-600 text-white shadow-indigo-200">
                    <i class="fas fa-bell menu-icon text-white/90"></i>
                    <span class="font-extrabold text-3xl">æé†’äº‹é …</span>
                </button>
            </div>
            
            <div class="content-card mt-8 bg-purple-50 border-purple-300 border-4">
                <h3 class="font-bold text-2xl mb-4 text-purple-900 flex items-center"><i class="fas fa-smile text-purple-700 mr-3 text-4xl"></i> ä½ ä»Šæ—¥å¿ƒæƒ…é»å‘€ï¼Ÿ</h3>
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button onclick="getMoodTip('happy')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="é–‹å¿ƒ">ğŸ˜Š</button>
                    <button onclick="getMoodTip('excited')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="èˆˆå¥®">ğŸ¤©</button>
                    <button onclick="getMoodTip('silly')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="é¬¼é¦¬">ğŸ˜œ</button>
                    <button onclick="getMoodTip('cool')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="ç€Ÿç‘">ğŸ˜</button>
                    <button onclick="getMoodTip('calm')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="å¹³éœ">ğŸ˜Œ</button>
                    <button onclick="getMoodTip('grateful')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="æ„Ÿæ©">ğŸ¥°</button>
                    <button onclick="getMoodTip('loved')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="è¢«æ„›">ğŸ˜</button>
                    <button onclick="getMoodTip('thinking')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="æ€è€ƒ">ğŸ¤”</button>
                    <button onclick="getMoodTip('tired')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="ç–²å€¦">ğŸ˜´</button>
                    <button onclick="getMoodTip('confused')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="å›°æƒ‘">ğŸ˜•</button>
                    <button onclick="getMoodTip('surprised')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="é©šè¨">ğŸ˜®</button>
                    <button onclick="getMoodTip('sick')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="ä¸é©">ğŸ¤’</button>
                    <button onclick="getMoodTip('anxious')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="ç„¦æ…®">ğŸ˜Ÿ</button>
                    <button onclick="getMoodTip('sad')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="å‚·å¿ƒ">ğŸ˜¢</button>
                    <button onclick="getMoodTip('angry')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="ç”Ÿæ°£">ğŸ˜ </button>
                    <button onclick="getMoodTip('frustrated')" class="aspect-square rounded-2xl bg-white border-2 border-purple-100 hover:border-purple-300 flex items-center justify-center leading-none overflow-hidden shadow-sm active:scale-95 transition-all p-0" style="font-size: 140px;" title="æ°£é¤’">ğŸ˜¤</button>
                </div>
                <p class="text-center text-gray-500 text-lg font-medium mb-2">é»æ“Šè¡¨æƒ…ç‡å»ºè­°</p>
                <div id="mood-result" class="mt-4 text-purple-900 font-bold text-xl leading-relaxed bg-white p-4 rounded-xl border border-purple-100 shadow-sm min-h-[4rem]"></div>
            </div>
        </div>

        <!-- VIEW: NOTES -->
        <div id="view-notes" class="view-section">
            <h2 class="text-3xl font-extrabold mb-6 px-2 text-yellow-900">è¦†è¨ºç­†è¨˜</h2>
            <div class="content-card border-yellow-200 border-2">
                <label class="font-bold text-gray-600">åœ°é» / é†«ç”Ÿ</label>
                <input type="text" id="notes-input-location" placeholder="ä¾‹å¦‚ï¼šé™³é†«ç”Ÿ">
                
                <label class="font-bold text-gray-600 mt-2">èªéŸ³èªè¨€</label>
                <select id="notes-lang-select" class="mb-4">
                    <option value="zh-HK">å»£æ±è©± (Cantonese)</option>
                    <option value="en-US">è‹±æ–‡ (English)</option>
                    <option value="zh-CN">æ™®é€šè©± (Mandarin)</option>
                </select>

                <label class="font-bold text-gray-600 mt-2">éŒ„éŸ³</label>
                <button id="record-btn" onclick="toggleRecord()" class="btn-primary w-full py-5 rounded-2xl mb-5 text-xl flex items-center justify-center gap-3">
                    <i class="fas fa-microphone text-3xl"></i> é–‹å§‹éŒ„éŸ³
                </button>
                
                <!-- Status Indicator for Analysis -->
                <div id="note-analysis-status" class="hidden text-center p-3 bg-yellow-100 text-yellow-800 rounded-xl mb-3 font-bold border border-yellow-200">
                    <i class="fas fa-spinner fa-spin mr-2"></i> AI æ­£åœ¨ç¸½çµä¸­...
                </div>

                <!-- UPDATED LABEL with Status -->
                <div class="flex justify-between items-end mb-1">
                    <label class="font-bold text-gray-600">å³æ™‚ç­†è¨˜ / åˆ†æ</label>
                    <span id="recording-status" class="text-sm font-extrabold text-red-500 animate-pulse h-5"></span>
                </div>
                
                <textarea id="notes-summary-output" rows="5" placeholder="ä½ çš„ç­†è¨˜æœƒé¡¯ç¤ºåœ¨é€™è£¡..." class="bg-gray-50 transition-colors duration-300"></textarea>
                
                <!-- NEW: Analyze Button -->
                <button id="btn-analyze-note" onclick="analyzeNoteText()" class="hidden w-full py-3 rounded-xl bg-gradient-to-r from-amber-400 to-orange-500 text-white font-bold text-lg mb-4 shadow-md flex items-center justify-center gap-2">
                    <i class="fas fa-magic"></i> åˆ†æåŠç¸½çµ
                </button>

                <div class="flex gap-3 mt-2">
                    <button id="btn-save-note" onclick="saveNote()" class="flex-[2] btn-primary py-4 rounded-2xl text-xl shadow-lg">å„²å­˜ç­†è¨˜</button>
                    <button onclick="confirmClearDraft()" class="flex-1 bg-white border-2 border-red-200 text-red-500 py-4 rounded-2xl font-bold text-xl shadow-sm hover:bg-red-50">æ¸…é™¤</button>
                </div>
            </div>
            <h3 class="font-bold text-gray-500 px-2 mb-3 text-xl">æ­·å²è¨˜éŒ„</h3>
            <div id="saved-notes-list"></div>
        </div>

        <!-- VIEW: MEDICINE (AI VISION DUAL SCAN) -->
        <div id="view-medicine" class="view-section">
            <h2 class="text-3xl font-extrabold mb-6 px-2 text-red-900">è—¥ç‰©æƒæå™¨</h2>
            <div class="content-card border-red-200 border-2">
                <div id="video-container" class="hidden relative aspect-[4/3] mb-4">
                    <video id="video-feed" autoplay playsinline muted></video>
                    <div id="scan-overlay-box" class="scan-overlay border-white"></div>
                    <div id="scan-instruction-text" class="instruction-badge">æƒææ¨™ç±¤</div>
                </div>

                <!-- MOVED & UPDATED: Capture Button (Right below camera, Black Text) -->
                <button id="capture-btn" onclick="captureScan()" class="w-full py-5 rounded-2xl text-xl mb-4 hidden font-extrabold shadow-lg flex items-center justify-center gap-3 bg-white border-4 border-red-500 text-black hover:bg-red-50 active:scale-95 transition-all">
                    <i class="fas fa-camera text-3xl text-red-600"></i> æ‹æ”ç…§ç‰‡
                </button>
                
                <div id="scan-status" class="hidden text-center p-4 bg-yellow-50 text-yellow-800 rounded-xl mb-4 font-bold border border-yellow-200">
                    <i class="fas fa-spinner fa-spin mr-2"></i> åˆ†æå½±åƒä¸­...
                </div>

                <!-- Capture Buttons Area -->
                <div id="scan-controls">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Label Preview Box -->
                        <div class="flex flex-col gap-2">
                            <div id="preview-label" class="bg-gray-100 rounded-xl h-40 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative">
                                <span class="text-gray-400 font-bold text-center p-2"><i class="fas fa-file-alt text-3xl mb-1 block"></i>æ¨™ç±¤</span>
                            </div>
                            <!-- Manual button just in case -->
                            <button onclick="startCam('label')" class="btn-secondary py-3 rounded-xl font-bold text-sm bg-red-50 text-red-700 border-red-200">
                                <i class="fas fa-camera mr-1"></i> é‡æ‹æ¨™ç±¤
                            </button>
                        </div>
                        
                        <!-- Appearance Preview Box -->
                        <div class="flex flex-col gap-2">
                            <div id="preview-appearance" class="bg-gray-100 rounded-xl h-40 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative">
                                <span class="text-gray-400 font-bold text-center p-2"><i class="fas fa-pills text-3xl mb-1 block"></i>è—¥ä¸¸/å¤–è§€</span>
                            </div>
                            <!-- Manual button just in case -->
                            <button onclick="startCam('appearance')" class="btn-secondary py-3 rounded-xl font-bold text-sm bg-red-50 text-red-700 border-red-200">
                                <i class="fas fa-camera mr-1"></i> é‡æ‹å¤–è§€
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Start Start Button -->
                <button id="start-camera-btn" onclick="startCam('label')" class="btn-primary w-full py-5 rounded-2xl text-xl mb-5 bg-gradient-to-r from-red-500 to-pink-600 flex items-center justify-center gap-3">
                    <i class="fas fa-camera text-3xl"></i> æƒæè—¥ç“¶
                </button>

                <!-- Analyze Button (Hidden by default, used if auto-flow fails or manual usage) -->
                <button onclick="analyzeDualImages()" id="analyze-btn" class="hidden btn-primary w-full py-5 rounded-2xl text-xl mb-5 bg-gradient-to-r from-red-500 to-pink-600 flex items-center justify-center gap-3">
                    <i class="fas fa-magic text-3xl"></i> ç«‹å³åˆ†æ
                </button>
                
                <input type="hidden" id="ocr-category-input">
                <div id="ocr-category-display" class="hidden"></div>

                <label class="font-bold text-gray-600">è—¥ç‰©åç¨±</label>
                <textarea id="ocr-output" rows="2" placeholder="åµæ¸¬åˆ°çš„åç¨±æœƒé¡¯ç¤ºåœ¨é€™è£¡..." class="mb-4"></textarea>
                
                <label class="font-bold text-gray-600">è§£é‡‹</label>
                <textarea id="ocr-summary-output" rows="4" placeholder="AI è§£é‡‹..." readonly class="bg-gray-50 mb-6"></textarea>
                
                <div class="flex gap-3">
                    <button id="btn-save-scan" onclick="saveScan()" class="flex-[2] btn-secondary py-4 rounded-2xl font-bold text-xl border-red-300 text-red-800 shadow-sm">å„²å­˜è³‡æ–™</button>
                    <button onclick="clearScan()" class="flex-1 bg-white border-2 border-gray-300 text-gray-500 py-4 rounded-2xl font-bold text-xl shadow-sm hover:bg-gray-50">æ”¾æ£„</button>
                </div>
            </div>
            <h3 class="font-bold text-gray-500 px-2 mb-3 text-xl">å·²å„²å­˜è—¥ç‰©</h3>
            <div id="saved-medicine-list"></div>
        </div>

        <!-- VIEW: CONTACTS -->
        <div id="view-contacts" class="view-section">
            <h2 class="text-3xl font-extrabold mb-6 px-2 text-blue-900">è¯çµ¡äºº</h2>
            <div class="content-card border-blue-200 border-2">
                <input type="text" id="c-name" placeholder="å§“å (ä¾‹å¦‚: é™³é†«ç”Ÿ)">
                <input type="text" id="c-role" placeholder="è·ä½ (ä¾‹å¦‚: å¿ƒè‡Ÿç§‘)">
                <input type="tel" id="c-phone" placeholder="é›»è©±è™Ÿç¢¼">
                
                <div class="flex gap-2 mt-4">
                    <button id="btn-save-contact" onclick="addContact()" class="btn-primary flex-1 py-4 rounded-2xl text-xl bg-gradient-to-r from-blue-500 to-cyan-500">æ–°å¢è¯çµ¡äºº</button>
                    <button id="btn-cancel-contact" onclick="cancelEditContact()" class="hidden w-24 py-4 rounded-2xl text-lg bg-gray-200 text-gray-600 font-bold">å–æ¶ˆ</button>
                </div>
            </div>
            <div id="contacts-list"></div>
        </div>

        <!-- VIEW: REMINDERS -->
        <div id="view-reminders" class="view-section">
            <h2 class="text-3xl font-extrabold mb-6 px-2 text-indigo-900">æé†’äº‹é …</h2>
            <div class="content-card border-indigo-200 border-2">
                
                <label class="font-bold text-gray-600">é ç´„ / ä»»å‹™</label>
                <div class="flex gap-3 mb-5 items-center">
                    <!-- Mic Button First -->
                    <button id="btn-record-reminder" onclick="toggleReminderRecord()" 
                            class="flex-1 h-24 bg-indigo-500 text-black rounded-2xl shadow-md flex items-center justify-center active:scale-95 transition-all border-b-4 border-indigo-600 active:border-b-0 active:translate-y-1">
                        <i class="fas fa-microphone text-5xl text-black"></i> 
                    </button>

                    <!-- Input Second -->
                    <input type="text" id="r-name" 
                           class="w-40 h-24 text-xl border-4 border-gray-300 rounded-2xl px-3 bg-gray-50 focus:border-indigo-500 focus:bg-white transition-colors outline-none shadow-inner text-center" 
                           placeholder="äº‹é …" 
                           style="margin-bottom: 0;">
                </div>

                <!-- Added Date Input -->
                <label class="font-bold text-gray-600">æ—¥æœŸ</label>
                <input type="date" id="r-date" class="h-20 text-2xl mb-5 bg-white">

                <label class="font-bold text-gray-600">æ™‚é–“</label>
                <input type="time" id="r-time" class="h-20 text-2xl mb-5 bg-white">

                <button onclick="addReminder()" class="btn-primary w-full py-5 rounded-2xl text-xl bg-indigo-600 text-white shadow-indigo-400 flex items-center justify-center gap-3">
                    <i class="fas fa-plus-circle text-3xl"></i> è¨­å®šæé†’
                </button>
            </div>
            
            <h3 class="font-bold text-gray-500 px-2 mb-3 text-xl">å·²å„²å­˜æé†’</h3>
            <div id="reminders-list"></div>
        </div>

        <!-- NEW: VIEW TRANSPORT -->
        <div id="view-transport" class="view-section">
            <h2 class="text-3xl font-extrabold mb-6 px-2 text-teal-900">äº¤é€š</h2>
            <div class="content-card border-teal-200 border-2">
                
                <!-- START LOCATION (Updated to match Destination format) -->
                <label class="font-bold text-gray-600">å‡ºç™¼åœ°</label>
                <div class="flex gap-3 mb-5 items-center">
                    <button id="btn-record-transport-start" onclick="toggleTransportStartRecord()" 
                            class="flex-1 h-24 bg-amber-500 text-black rounded-2xl shadow-md flex items-center justify-center active:scale-95 transition-all border-b-4 border-amber-600 active:border-b-0 active:translate-y-1">
                        <i class="fas fa-microphone text-5xl"></i>
                    </button>

                    <input type="text" id="transport-start" 
                           class="w-40 h-24 text-xl border-4 border-gray-300 rounded-2xl px-3 bg-gray-50 focus:border-teal-500 focus:bg-white transition-colors outline-none shadow-inner text-center" 
                           placeholder="å‡ºç™¼åœ°" 
                           style="margin-bottom: 0;">
                </div>

                <label class="font-bold text-gray-600">ç›®çš„åœ°</label>
                
                <div class="flex gap-3 mb-5 items-center">
                    <!-- SWAPPED: Mic Button is now First (Left) and Large (flex-1) -->
                    <button id="btn-record-transport" onclick="toggleTransportRecord()" 
                            class="flex-1 h-24 bg-amber-500 text-black rounded-2xl shadow-md flex items-center justify-center active:scale-95 transition-all border-b-4 border-amber-600 active:border-b-0 active:translate-y-1">
                        <i class="fas fa-microphone text-5xl"></i>
                    </button>

                    <!-- SWAPPED: Input is now Second (Right) and Smaller (Fixed Width) -->
                    <input type="text" id="transport-dest" 
                           class="w-40 h-24 text-xl border-4 border-gray-300 rounded-2xl px-3 bg-gray-50 focus:border-teal-500 focus:bg-white transition-colors outline-none shadow-inner text-center" 
                           placeholder="ç›®çš„åœ°" 
                           style="margin-bottom: 0;">
                </div>
                
                <button onclick="openTransport()" class="btn-primary w-full py-5 rounded-2xl mb-5 text-xl bg-gradient-to-r from-teal-500 to-emerald-500 shadow-teal-200 flex items-center justify-center gap-3">
                    <i class="fas fa-map-marked-alt text-3xl"></i> æœå°‹å·´å£« / æ¸¯éµ
                </button>
                
                <button onclick="callTaxi()" class="btn-primary w-full py-5 rounded-2xl text-xl bg-red-600 text-white shadow-red-400 flex items-center justify-center gap-3">
                    <i class="fas fa-phone-alt text-3xl"></i> è‡´é›»çš„å£«å° (2760 0455)
                </button>
            </div>
        </div>

    </div>

    <!-- TAB BAR -->
    <nav class="tab-bar">
        <button class="tab-button active" onclick="switchTab('menu')" id="tab-menu">
            <i class="fas fa-home"></i> ä¸»é 
        </button>
        <button class="tab-button" onclick="switchTab('notes')" id="tab-notes">
            <i class="fas fa-microphone"></i> ç­†è¨˜
        </button>
        <button class="tab-button" onclick="switchTab('medicine')" id="tab-medicine">
            <i class="fas fa-pills"></i> è—¥ç‰©
        </button>
        <button class="tab-button" onclick="switchTab('contacts')" id="tab-contacts">
            <i class="fas fa-phone"></i> è¯çµ¡
        </button>
        <button class="tab-button" onclick="switchTab('reminders')" id="tab-reminders">
            <i class="fas fa-bell"></i> æé†’
        </button>
        <button class="tab-button" onclick="switchTab('transport')" id="tab-transport">
            <i class="fas fa-bus"></i> äº¤é€š
        </button>
    </nav>

    <!-- CONFIRM MODAL -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center border-4 border-red-100">
            <div class="text-red-500 mb-6"><i class="fas fa-exclamation-circle text-6xl"></i></div>
            <h3 class="text-2xl font-extrabold mb-3 text-gray-800">åˆªé™¤æ­¤é …ç›®ï¼Ÿ</h3>
            <p class="text-gray-500 text-lg mb-8">æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex gap-4">
                <button onclick="executeDelete()" class="flex-1 bg-red-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg">åˆªé™¤</button>
                <button onclick="closeModal('confirm-modal')" class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold text-lg border-2 border-gray-200">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ALERT MODAL -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center border-4 border-indigo-100">
            <div id="alert-msg" class="text-xl font-bold text-gray-800 mb-8 leading-relaxed"></div>
            <button onclick="closeModal('alert-modal')" class="btn-primary w-full py-4 rounded-2xl font-bold text-xl">ç¢ºå®š</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONNECT TO SERVER (Add this at the top of script) ---
        async function askServerAI(promptText, base64Image = null) {
        try {
            // *** CHANGE THIS URL to your actual Render URL ***
            const serverUrl = 'https://my-ai-app-wjv0.onrender.com/ask-ai'; 
            
            const response = await fetch(serverUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt: promptText, 
                    imageBase64: base64Image 
                })
            });
            
            if (!response.ok) throw new Error("Server error");
            const data = await response.json();
            return data.response; 
        } catch (error) {
            console.error("Connection failed:", error);
            return "ç„¡æ³•é€£æ¥ AI ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
        }

        // CONFIGURATION
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'elderly-care-app-default';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = 'guest';

        // GLOBAL STATE
        window.AppState = {
            db: null, userId: null,
            notes: [], medicineScans: [], contacts: [], reminders: [],
            geminiApiKey: localStorage.getItem('gemini_api_key') || "",
            
            // Recorders
            isRecording: false,
            recognition: null, // text
            mediaRecorder: null, // audio
            audioChunks: [],
            currentAudioBase64: null,

            currentLabelImg: null,     // State for Label Image
            currentAppearanceImg: null, // State for Appearance Image
            scanningType: null,        // 'label' or 'appearance'
            editingContactId: null,
            
            // Player State (Unified)
            currentSpeechId: null,
            playerMode: null, // 'tts' or 'audio'
            speechText: null, // for tts: The full text content
            isPaused: false,  // Track explicit pause
            speechUtterance: null, 
            audioElem: null, 
            speechCharIndex: 0,
            isDragging: false, // Track if user is scrubbing
            
            // Transport Recorder
            isTransportRecording: false,
            transportRecognition: null,
            transportSilenceTimer: null,

            // Transport START Recorder (NEW)
            isTransportStartRecording: false,
            transportStartRecognition: null,
            transportStartSilenceTimer: null,
            
            // Reminder Recorder
            isReminderRecording: false,
            reminderRecognition: null,
            reminderSilenceTimer: null
        };

        // --- HELPERS (Defined before use) ---
        function escapeHtml(text) {
            if (!text) return text;
            if (typeof text !== 'string') return String(text);
            return text
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok && response.status === 429) { throw new Error('Rate limit exceeded'); }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // --- DATABASE HELPERS ---
        // Generates path for user-specific collection
        function getCollectionRef(coll) {
             if (!db || !userId || userId === 'guest') return null;
             return collection(db, 'artifacts', appId, 'users', userId, coll);
        }

        async function saveItem(collName, item) {
            if (!db || !userId || userId === 'guest') {
                window.showAlert("è³‡æ–™åº«æœªé€£ç·šæˆ–è™•æ–¼é›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•å„²å­˜ã€‚");
                return;
            }
            try {
                // Path: /artifacts/{appId}/users/{userId}/{collName}/{itemId}
                const itemRef = doc(db, 'artifacts', appId, 'users', userId, collName, item.id);
                await setDoc(itemRef, item);
            } catch(e) {
                console.error("Firestore Save Error:", e);
                window.showAlert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šã€‚");
                throw e; 
            }
        }

        async function deleteItem(collName, itemId) {
             if (!db || !userId) return;
             try {
                 const itemRef = doc(db, 'artifacts', appId, 'users', userId, collName, itemId);
                 await deleteDoc(itemRef);
             } catch(e) {
                 console.error("Delete Error", e);
                 window.showAlert("ç„¡æ³•åˆªé™¤é …ç›®ã€‚");
             }
        }

        function setupListeners() {
            if (!db || !userId) return;
            
            const collections = ['elder_notes', 'medicine_scans', 'medical_contacts', 'medication_reminders'];
            const mapKeys = ['notes', 'medicineScans', 'contacts', 'reminders'];

            collections.forEach((coll, idx) => {
                const key = mapKeys[idx];
                const ref = getCollectionRef(coll);
                if(ref) {
                    onSnapshot(ref, (snap) => {
                        window.AppState[key] = snap.docs.map(d => d.data());
                        // Refresh UI
                        if(key === 'notes' && document.getElementById('view-notes').classList.contains('active')) renderNotes();
                        if(key === 'medicineScans' && document.getElementById('view-medicine').classList.contains('active')) renderMeds();
                        if(key === 'contacts') renderContacts();
                        if(key === 'reminders') renderReminders();
                    });
                }
            });
        }


        // --- RENDERING FUNCTIONS ---

        function getCategoryStyle(cat) {
            const c = (cat || '').toLowerCase().trim();
            if (c.includes('heart') || c.includes('pressure') || c.includes('blood') || c.includes('cardio') || c.includes('cholesterol') || c.includes('statin') || c.includes('hypertension')) 
                return { icon: 'fa-heart-pulse', headerBg: 'bg-red-500', iconColor: 'text-red-600', borderColor: 'border-red-200', label: 'å¿ƒè‡Ÿ/è¡€å£“ (Heart & BP)' };
            
            if (c.includes('pain') || c.includes('relief') || c.includes('fever') || c.includes('headache') || c.includes('migraine') || c.includes('aspirin') || c.includes('ibuprofen') || c.includes('inflammatory')) 
                return { icon: 'fa-bandage', headerBg: 'bg-orange-500', iconColor: 'text-orange-600', borderColor: 'border-orange-200', label: 'æ­¢ç—›/ç™¼ç‡’ (Pain Relief)' };
            
            if (c.includes('diabetes') || c.includes('insulin') || c.includes('sugar') || c.includes('glucose') || c.includes('metformin')) 
                return { icon: 'fa-syringe', headerBg: 'bg-blue-500', iconColor: 'text-blue-600', borderColor: 'border-blue-200', label: 'ç³–å°¿ç—… (Diabetes)' };
            
            if (c.includes('breath') || c.includes('lung') || c.includes('asthma') || c.includes('cold') || c.includes('flu') || c.includes('cough') || c.includes('allergy') || c.includes('sinus') || c.includes('inhaler')) 
                return { icon: 'fa-lungs', headerBg: 'bg-teal-500', iconColor: 'text-teal-600', borderColor: 'border-teal-200', label: 'å‘¼å¸é“ (Respiratory)' };
            
            if (c.includes('brain') || c.includes('nerve') || c.includes('alzheimer') || c.includes('parkinson') || c.includes('seizure') || c.includes('memory') || c.includes('dementia') || c.includes('stroke') || c.includes('neuropathy') || c.includes('epilepsy')) 
                return { icon: 'fa-brain', headerBg: 'bg-violet-500', iconColor: 'text-violet-600', borderColor: 'border-violet-200', label: 'è…¦éƒ¨/ç¥ç¶“ (Brain & Nerves)' };
            
            if (c.includes('kidney') || c.includes('bladder') || c.includes('renal') || c.includes('urine') || c.includes('urinary') || c.includes('diuretic') || c.includes('prostate')) 
                return { icon: 'fa-water', headerBg: 'bg-sky-500', iconColor: 'text-sky-600', borderColor: 'border-sky-200', label: 'è…è‡Ÿ/æ³Œå°¿ (Kidney)' };
            
            if (c.includes('thyroid') || c.includes('hormone') || c.includes('endocrine') || c.includes('levothyroxine')) 
                return { icon: 'fa-dna', headerBg: 'bg-rose-500', iconColor: 'text-rose-600', borderColor: 'border-rose-200', label: 'ç”²ç‹€è…º/è·çˆ¾è’™ (Thyroid)' };
            
            if (c.includes('vitamin') || c.includes('supplement') || c.includes('calcium') || c.includes('iron') || c.includes('magnesium') || c.includes('fish oil')) 
                return { icon: 'fa-apple-whole', headerBg: 'bg-yellow-400', iconColor: 'text-yellow-600', borderColor: 'border-yellow-200', label: 'ç¶­ç”Ÿç´ /ä¿å¥ (Vitamin)' };
            
            if (c.includes('stomach') || c.includes('digest') || c.includes('acid') || c.includes('gastric') || c.includes('reflux') || c.includes('laxative') || c.includes('probiotic')) 
                return { icon: 'fa-utensils', headerBg: 'bg-purple-500', iconColor: 'text-purple-600', borderColor: 'border-purple-200', label: 'è…¸èƒƒ (Stomach)' };
            
            if (c.includes('antibiotic') || c.includes('infection') || c.includes('bacterial') || c.includes('penicillin') || c.includes('amoxicillin') || c.includes('virus')) 
                return { icon: 'fa-shield-virus', headerBg: 'bg-emerald-500', iconColor: 'text-emerald-600', borderColor: 'border-emerald-200', label: 'æŠ—ç”Ÿç´  (Antibiotic)' };
            
            if (c.includes('eye') || c.includes('vision') || c.includes('glaucoma') || c.includes('drops') || c.includes('optic')) 
                return { icon: 'fa-eye', headerBg: 'bg-cyan-500', iconColor: 'text-cyan-600', borderColor: 'border-cyan-200', label: 'çœ¼ç§‘ (Eye Care)' };
            
            if (c.includes('sleep') || c.includes('insomnia') || c.includes('anxiety') || c.includes('depression') || c.includes('mood') || c.includes('calm') || c.includes('sedative')) 
                return { icon: 'fa-moon', headerBg: 'bg-indigo-500', iconColor: 'text-indigo-600', borderColor: 'border-indigo-200', label: 'ç¡çœ /æƒ…ç·’ (Sleep & Mood)' };
            
            if (c.includes('skin') || c.includes('rash') || c.includes('itch') || c.includes('eczema') || c.includes('cream') || c.includes('ointment') || c.includes('topical')) 
                return { icon: 'fa-hand-dots', headerBg: 'bg-pink-500', iconColor: 'text-pink-600', borderColor: 'border-pink-200', label: 'çš®è†š (Skin)' };

            if (c.includes('bone') || c.includes('joint') || c.includes('arthritis') || c.includes('osteoporosis') || c.includes('calcium')) 
                return { icon: 'fa-bone', headerBg: 'bg-stone-500', iconColor: 'text-stone-600', borderColor: 'border-stone-200', label: 'éª¨éª¼/é—œç¯€ (Bone & Joint)' };

            return { icon: 'fa-pills', headerBg: 'bg-gray-500', iconColor: 'text-gray-600', borderColor: 'border-gray-200', label: 'ä¸€èˆ¬è—¥ç‰© (General Medicine)' };
        }

        async function renderNotes() {
            const list = document.getElementById('saved-notes-list');
            if(!list) return;
            const notes = window.AppState.notes || [];
            
            list.innerHTML = notes.map(n => {
                const date = new Date(n.timestamp).toLocaleDateString();
                const time = new Date(n.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const isCurrentItem = window.AppState.currentSpeechId === n.id;
                const isPlaying = isCurrentItem && !window.AppState.isPaused;
                const playerMode = window.AppState.playerMode; // 'audio' or 'tts'
                
                const progress = isCurrentItem 
                    ? (playerMode === 'tts' 
                        ? (window.AppState.speechCharIndex / (window.AppState.speechText?.length || 1)) * 100
                        : (window.AppState.audioElem?.currentTime / (window.AppState.audioElem?.duration || 1)) * 100)
                    : 0;

                const isAudioPlaying = isPlaying && playerMode === 'audio';
                const isTTSPlaying = isPlaying && playerMode === 'tts';
                
                const hasAudio = !!n.audioBase64;
                const summaryText = escapeHtml(n.summary || '');

                let controlsHTML = '';
                
                if (hasAudio) {
                    controlsHTML += `
                    <button onclick="togglePlayback('${n.id}', null, 'audio')" 
                            id="btn-audio-${n.id}"
                            class="flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm ${isAudioPlaying ? 'bg-red-500 text-white animate-pulse' : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'}">
                        <i class="fas ${isAudioPlaying ? 'fa-stop' : 'fa-microphone-lines'} text-lg"></i>
                        <span>éŒ„éŸ³</span>
                    </button>`;
                }
                
                controlsHTML += `
                <button onclick="togglePlayback('${n.id}', null, 'tts')" 
                        id="btn-tts-${n.id}"
                        class="flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm ${isTTSPlaying ? 'bg-blue-500 text-white animate-pulse' : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'}">
                    <i class="fas ${isTTSPlaying ? 'fa-stop' : 'fa-volume-high'} text-lg"></i>
                    <span>æœ—è®€ç¸½çµ</span>
                </button>`;

                return `
                <div class="content-card p-5 border-l-8 border-yellow-400 relative overflow-hidden" id="card-${n.id}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-sm font-bold text-gray-400 uppercase tracking-wide">${date} â€¢ ${time}</span>
                            <h4 class="text-2xl font-bold text-gray-800 mt-1">${escapeHtml(n.location)}</h4>
                        </div>
                        <button onclick="confirmDelete('elder_notes', '${n.id}')" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt text-xl"></i></button>
                    </div>
                    
                    <div class="mb-4 bg-gray-50 p-4 rounded-2xl border border-gray-100 flex flex-col gap-3">
                        <div class="flex gap-2 w-full">
                            ${controlsHTML}
                        </div>
                        <div class="w-full relative px-2">
                             <input type="range" 
                                    id="slider-${n.id}"
                                    min="0" max="100" value="${progress || 0}" step="1"
                                    oninput="handleSeek('${n.id}', this.value)"
                                    class="w-full h-8 cursor-pointer">
                             <div class="flex justify-between text-xs text-gray-400 font-bold px-1">
                                <span id="status-${n.id}">
                                    ${isPlaying ? (playerMode==='audio' ? 'æ’­æ”¾éŒ„éŸ³ä¸­...' : 'æœ—è®€ç¸½çµä¸­...') : (window.AppState.isPaused && isCurrentItem ? 'å·²æš«åœ' : 'æº–å‚™å°±ç·’')}
                                </span>
                             </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 text-lg text-gray-700 leading-relaxed">
                        ${summaryText}
                    </div>
                </div>`;
            }).join('');
        }

        async function renderMeds() {
            const list = document.getElementById('saved-medicine-list');
            if(!list) return;
            const meds = window.AppState.medicineScans || [];
            
            list.innerHTML = meds.map(m => {
                const style = getCategoryStyle(m.ocrText);
                const isCurrentItem = window.AppState.currentSpeechId === m.id;
                const isPlaying = isCurrentItem && !window.AppState.isPaused;
                const progress = isCurrentItem && window.AppState.playerMode === 'tts'
                    ? (window.AppState.speechCharIndex / (window.AppState.speechText?.length || 1)) * 100
                    : 0;
                
                const icon = isPlaying ? 'fa-pause' : 'fa-play';
                
                let imagesHtml = '';
                if(m.labelImage) imagesHtml += `<img src="${m.labelImage}" class="w-20 h-20 object-cover rounded-lg border border-gray-200" onclick="window.open(this.src)">`;
                if(m.appearanceImage) imagesHtml += `<img src="${m.appearanceImage}" class="w-20 h-20 object-cover rounded-lg border border-gray-200" onclick="window.open(this.src)">`;

                return `
                <div class="content-card p-0 overflow-hidden border-2 ${style.borderColor}" id="card-${m.id}">
                    <div class="${style.headerBg} p-4 text-white flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas ${style.icon} text-2xl opacity-90"></i>
                            <span class="font-bold text-lg opacity-90">${style.label}</span>
                        </div>
                        <button onclick="confirmDelete('medicine_scans', '${m.id}')" class="text-white/70 hover:text-white"><i class="fas fa-trash-alt text-xl"></i></button>
                    </div>
                    
                    <div class="p-5">
                        <h4 class="text-2xl font-extrabold text-gray-800 mb-2 leading-tight">${escapeHtml(m.ocrText)}</h4>
                        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">${imagesHtml}</div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-lg text-gray-700 leading-relaxed mb-4">
                            ${escapeHtml(m.summary)}
                        </div>
                        
                         <div class="mb-2 bg-slate-100 p-4 rounded-2xl border border-slate-200 flex flex-col items-center gap-2">
                            <button onclick="togglePlayback('${m.id}', null, 'tts')" 
                                    id="btn-play-${m.id}"
                                    class="w-full py-3 rounded-xl bg-slate-700 text-white font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95">
                                <i class="fas ${icon} text-xl"></i> æ”¶è½è§£é‡‹
                            </button>
                            <div class="w-full relative px-2">
                                 <input type="range" 
                                        id="slider-${m.id}"
                                        min="0" max="100" value="${progress || 0}" step="1"
                                        oninput="handleSeek('${m.id}', this.value)"
                                        class="w-full h-8 cursor-pointer">
                                 <div class="flex justify-between text-xs text-gray-500 font-bold px-1">
                                    <span id="status-${m.id}">${isPlaying ? 'æœ—è®€ä¸­...' : (window.AppState.isPaused && isCurrentItem ? 'å·²æš«åœ' : 'æ”¶è½')}</span>
                                 </div>
                            </div>
                        </div>

                    </div>
                </div>`;
            }).join('');
        }
        
        async function renderContacts() {
            const list = document.getElementById('contacts-list');
            if(!list) return;
            
            // 10 Default Contacts (Hong Kong Context)
            const defaultContacts = [
                { id: 'def_999', name: 'é¦™æ¸¯ç´…åå­—æœƒ â€“ é™ªè¨ºæœå‹™', role: 'æä¾›ç¾©å·¥é™ªè¨ºã€æ”¯æ´é•·è€…æˆ–è¡Œå‹•ä¸ä¾¿è€…å‰å¾€å°±è¨º', phone: '2507 7135' },
                { id: 'def_pws', name: 'è–é›…å„ç¦ç¾¤æœƒ â€“ é•·è€…é™ªè¨ºæœå‹™', role: 'æä¾›ç¾©å·¥é™ªè¨ºï¼Œæ”¯æ´è¼ªæ¤…ä½¿ç”¨è€…åŠé•·è€…å°±é†«è¡Œç¨‹', phone: '2835 4321' },
                { id: 'def_ha', name: 'ä»æ„›å ‚ â€“ é†«ç™‚é™ªè¨ºæœå‹™', role: 'å®‰æ’å°ˆäººé™ªåŒå°±è¨ºï¼ŒåŒ…æ‹¬äº¤é€šå”åŠ©èˆ‡ç¿»è­¯', phone: '2655 7711' },
                { id: 'def_swd', name: 'ä¿è‰¯å±€ â€“ é•·è€…é™ªè¨ºæœå‹™', role: 'å®‰æ’å·¥ä½œäººå“¡æˆ–ç¾©å·¥é™ªè¨ºï¼Œæ”¯æ´ç¨å±…é•·è€…', phone: '2277 8888' },
                { id: 'def_dh', name: 'æ±è¯ä¸‰é™¢ â€“ é†«ç™‚é™ªè¨ºæ”¯æ´è¨ˆåŠƒ', role: 'æä¾›é™ªè¨ºèˆ‡ç°¡å–®è­·ç†æ”¯æ´ï¼Œé©åˆé•·æœŸç—…æ‚£è€…', phone: '2548 7111' },
                { id: 'def_nea', name: 'é¦™æ¸¯åŸºç£æ•™å¥³é’å¹´æœƒï¼ˆYWCAï¼‰ â€“ é™ªè¨ºç¾©å·¥æœå‹™', role: 'ç¾©å·¥é™ªè¨ºæœå‹™ï¼Œæ”¯æ´è¦–éšœã€é•·è€…æˆ–è¡Œå‹•ä¸ä¾¿è€…', phone: '3476 1340' },
                { id: 'def_csh', name: 'æ˜æ„› â€“ é•·è€…é™ªè¨ºæ”¯æ´æœå‹™', role: 'é™ªè¨ºæœå‹™çµåˆç¤¾å·¥æ”¯æ´ï¼Œç‰¹åˆ¥é‡å°å¼±å‹¢ç¾¤é«”', phone: '3589 2300' },
                { id: 'def_sje', name: 'St. John Ambulance (è–ç´„ç¿°)', role: 'éç·Šæ€¥æ•‘è­·è»Šé ç´„', phone: '1878000' },
                { id: 'def_red', name: 'å„ªå¥é™ªè¨ºæœå‹™ï¼ˆU-Healthcareï¼‰', role: 'ç§ç‡Ÿå°ˆæ¥­é™ªè¨ºï¼Œé…å‚™é†«è­·äººå“¡ï¼Œå¯æŒ‰éœ€å®šåˆ¶è¡Œç¨‹', phone: '3705 2760' },
                { id: 'def_eld', name: 'é¦™æ¸¯å¾©åº·æœƒ â€“ é™ªè¨ºå®‰æ’æœå‹™', role: 'é…åˆå¾©åº·å·´å£«ï¼Œæä¾›é™ªè¨ºèˆ‡å”åŠ©ç™»è¨˜ç­‰æœå‹™', phone: '2817 8154' }
            ];

            const userContacts = window.AppState.contacts || [];
            
            // Merge defaults with user contacts
            const allContacts = [...defaultContacts, ...userContacts];
            
            list.innerHTML = allContacts.map(c => {
                const isDefault = c.id.startsWith('def_');
                // Style differentiation for defaults (e.g., slight background tint)
                const bgClass = isDefault ? 'bg-blue-50 border-blue-200' : 'bg-white border-blue-100';
                const deleteButton = isDefault ? '' : `
                    <button onclick="confirmDelete('medical_contacts', '${c.id}')" class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center hover:bg-red-100 hover:text-red-500">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;

                // Defaults are not editable via the same form easily without confusing ID logic, 
                // so we disable the click-to-edit for defaults
                const clickAction = isDefault ? '' : `onclick="editContact('${c.id}')"`;

                return `
                <div class="${bgClass} p-4 rounded-2xl shadow-sm border mb-3 flex items-center justify-between">
                    <div class="flex items-center gap-4 flex-1" ${clickAction}>
                        <div class="w-14 h-14 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xl">
                            ${c.name.charAt(0)}
                        </div>
                        <div>
                            <h4 class="font-bold text-xl text-gray-800">${escapeHtml(c.name)}</h4>
                            <p class="text-blue-500 font-medium">${escapeHtml(c.role)}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <a href="tel:${c.phone}" class="w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                            <i class="fas fa-phone text-xl"></i>
                        </a>
                        ${deleteButton}
                    </div>
                </div>
            `;
            }).join('');
        }

        async function renderReminders() {
            const list = document.getElementById('reminders-list');
            if(!list) return;
            const reminders = window.AppState.reminders || [];
            
            // Sort by date/time (optional improvement)
            reminders.sort((a, b) => {
                const dateA = new Date((a.date || '1970-01-01') + 'T' + (a.time || '00:00'));
                const dateB = new Date((b.date || '1970-01-01') + 'T' + (b.time || '00:00'));
                return dateA - dateB;
            });

            list.innerHTML = reminders.map(r => `
                <div class="content-card p-5 border-l-8 border-indigo-500 relative overflow-hidden mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-2xl font-extrabold text-indigo-900">${r.time}</span>
                                <span class="text-lg font-medium text-gray-500">${r.date || ''}</span>
                            </div>
                            <h4 class="text-xl font-bold text-gray-700 mt-1">${escapeHtml(r.name)}</h4>
                        </div>
                        <button onclick="confirmDelete('medication_reminders', '${r.id}')" class="text-gray-300 hover:text-red-500 p-2">
                            <i class="fas fa-trash-alt text-xl"></i>
                        </button>
                    </div>
                    
                    <button onclick="addToCalendar('${escapeHtml(r.name)}', '${r.date}', '${r.time}')" 
                            class="w-full py-3 rounded-xl bg-white border-2 border-indigo-100 text-indigo-600 font-bold flex items-center justify-center gap-2 shadow-sm hover:bg-indigo-50 transition-all">
                        <i class="fab fa-google text-xl"></i> åŠ åˆ° Google æ—¥æ›†
                    </button>
                </div>
            `).join('');
        }

        // --- APP LOGIC ---

        // AUTH & INIT (Same as before)
        async function initApp() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            window.AppState.db = db;

            // Auth Logic
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (e) { console.error("Token Auth Failed", e); await signInAnonymously(auth); }
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    window.AppState.userId = userId;
                    document.getElementById('user-id-display').textContent = `ID: ${userId.substring(0,6)}`;
                    setupListeners();
                } else {
                    document.getElementById('user-id-display').textContent = "é›¢ç·šæ¨¡å¼";
                }
            });
        }

        // NAVIGATION
        function switchTab(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('view-' + viewId);
            if(target) target.classList.add('active');
            
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            const tabBtn = document.getElementById('tab-' + viewId);
            if(tabBtn) tabBtn.classList.add('active');
            else {
                const home = document.getElementById('tab-menu');
                if(home) home.classList.remove('active'); 
            }
            
            // Re-render to ensure slider is in correct state if it was playing
            if(viewId === 'notes') renderNotes();
            if(viewId === 'medicine') renderMeds();
            if(viewId === 'reminders') renderReminders();
            
            window.scrollTo(0,0);
        }
        window.switchTab = switchTab;

        // MOOD
        function getMoodTip(mood) {
            // Massive Database of Classic Cantopop (70s-90s) mapped to moods
            const songDatabase = {
                'happy': [
                    { t: "å–œæ°£æ´‹æ´‹", a: "å¾å°é³³ (Paula Tsui)", q: "å–œæ°£æ´‹æ´‹ å¾å°é³³", msg: "å¿ƒæƒ…å’å¥½ï¼Œè½é¦–å–œæ°£æ´‹æ´‹å•¦ï¼" },
                    { t: "è²¡ç¥åˆ°", a: "è¨±å† å‚‘ (Samuel Hui)", q: "è²¡ç¥åˆ° è¨±å† å‚‘", msg: "ç¬‘å£å¸¸é–‹ï¼Œå¥½é‹è‡ªç„¶ä¾†ï¼" },
                    { t: "æ­¡æ¨‚ä»Šå®µ", a: "ç¾¤æ˜Ÿ (EYT Theme)", q: "æ­¡æ¨‚ä»Šå®µ æ™šå®‰æ­Œ", msg: "ç¶“å…¸å›æ†¶ï¼Œç¥ä½ æ™šæ™šæ­¡æ¨‚ï¼" },
                    { t: "å¤§å®¶è·Ÿä½å”±", a: "è¨±å† å‚‘ (Samuel Hui)", q: "å¤§å®¶è·Ÿä½å”± è¨±å† å‚‘", msg: "æ‹æ‹æ‰‹ï¼Œå¤§å®¶ä¸€é½Šå”±ï¼" },
                    { t: "ç¥å£½æ­Œ", a: "é„­éŒ¦æ˜Œ (Cheng Kam Cheong)", q: "ç¥å£½æ­Œ é„­éŒ¦æ˜Œ", msg: "ç¦å¦‚æ±æµ·ï¼Œå£½æ¯”å—å±±ï¼" },
                    { t: "å¿«æ¨‚ä¼´ä¾¶", a: "é™³å¯¶ç  å‘‚å¥‡", q: "å¿«æ¨‚ä¼´ä¾¶ é™³å¯¶ç ", msg: "å¿«å¿«æ¨‚æ¨‚ï¼Œæ­Œè²è™•è™•èã€‚" },
                    { t: "æ­¡æ¨‚å¹´å¹´", a: "é„­å°‘ç§‹ æ±ªæ˜èƒ", q: "æ­¡æ¨‚å¹´å¹´ é„­å°‘ç§‹ æ±ªæ˜èƒ", msg: "æ­¡æ­¡å–œå–œï¼Œå¹´å¹´æœ‰ä»Šæ—¥ï¼" },
                    { t: "è¿æ˜¥èŠ±", a: "åˆ˜æ¸…æ²¨", q: "è¿æ˜¥èŠ± ç²µèª", msg: "å¥½ä¸€æœµè¿æ˜¥èŠ±ï¼Œäººäººéƒ½æ„›å®ƒï¼" },
                    { t: "è«ç­‰å¾…", a: "è¨±å† å‚‘ (Samuel Hui)", q: "è«ç­‰å¾… è¨±å† å‚‘", msg: "è«ç­‰å¾…ï¼Œå…‰é™°ä¸æœƒå¾©ä¾†ï¼Œå¿«æ¨‚è¦åŠæ™‚ï¼" },
                    { t: "å‹åˆ©é›™æ‰‹å‰µ", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "å‹åˆ©é›™æ‰‹å‰µ è‘‰æŒ¯æ£ ", msg: "é–‹å¿ƒå¿«æ¨‚ï¼Œå‹åˆ©é›™æ‰‹å‰µï¼" }
                ],
                'excited': [
                    { t: "åŠæ–¤å…«å…©", a: "è¨±å† å‚‘ (Samuel Hui)", q: "åŠæ–¤å…«å…© è¨±å† å‚‘", msg: "å’ç²¾ç¥ï¼Œè½é¦–ç¶“å…¸æ­Œæ…¶ç¥ä¸‹ï¼" },
                    { t: "å°æé£›åˆ€", a: "ç¾…æ–‡ (Roman Tam)", q: "å°æé£›åˆ€ ç¾…æ–‡", msg: "è±ªæƒ…å£¯å¿—ï¼Œå……æ»¿æ´»åŠ›ï¼" },
                    { t: "è¬æ°´åƒå±±ç¸±æ©«", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "è¬æ°´åƒå±±ç¸±æ©« é—œæ­£å‚‘", msg: "æ°£é­„æ›´å£¯ï¼Œå‹‡å¾€ç›´å‰ï¼" },
                    { t: "ä¸–é–“å§‹çµ‚ä½ å¥½", a: "ç¾…æ–‡ ç”„å¦®", q: "ä¸–é–“å§‹çµ‚ä½ å¥½ ç¾…æ–‡ ç”„å¦®", msg: "å•ä¸–é–“æ˜¯å¦æ­¤å±±æœ€é«˜ï¼" },
                    { t: "å¼·äºº", a: "ç¾…æ–‡ (Roman Tam)", q: "å¼·äºº ç¾…æ–‡", msg: "åšå€‹å¼·äººï¼Œä¸€é£›æ²–å¤©ï¼" },
                    { t: "è¬é‡Œé•·åŸæ°¸ä¸å€’", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "è¬é‡Œé•·åŸæ°¸ä¸å€’ è‘‰æŒ¯æ£ ", msg: "ç²¾ç¥å¥•å¥•ï¼Œæ°£å‹¢å¦‚è™¹ï¼" },
                    { t: "å‹‡æ•¢çš„ä¸­åœ‹äºº", a: "æ±ªæ˜èƒ (Liza Wang)", q: "å‹‡æ•¢çš„ä¸­åœ‹äºº æ±ªæ˜èƒ", msg: "åšå€‹å‹‡æ•¢çš„äººï¼Œç†±è¡€æ²¸é¨°ï¼" },
                    { t: "ä¼´æˆ‘å•Ÿèˆª", a: "å°è™éšŠ", q: "ä¼´æˆ‘å•Ÿèˆª å°è™éšŠ", msg: "æšå¸†å‡ºæµ·ï¼Œå……æ»¿æœæ°£ï¼" },
                    { t: "ä¸Šæµ·ç˜", a: "è‘‰éº—å„€ (Frances Yip)", q: "ä¸Šæµ·ç˜ è‘‰éº—å„€", msg: "æµªå¥”ï¼Œæµªæµï¼Œæ°£å‹¢ç£…ç¤´ï¼" },
                    { t: "æˆå‰æ€æ±—", a: "æ—å­ç¥¥ (George Lam)", q: "æˆå‰æ€æ±— æ—å­ç¥¥", msg: "é¢¨æ²™ä¹‹ä¸­ï¼Œå……æ»¿åŠ›é‡ï¼" }
                ],
                'silly': [
                    { t: "æ‰“é›€è‹±é›„å‚³", a: "è¨±å† å‚‘ (Samuel Hui)", q: "æ‰“é›€è‹±é›„å‚³ è¨±å† å‚‘", msg: "åšäººæœ€ç·Šè¦é–‹å¿ƒï¼Œè½ä¸‹æ­Œä»”ç¬‘ä¸‹ï¼" },
                    { t: "åŠ åƒ¹ç†±æ½®", a: "è¨±å† å‚‘ (Samuel Hui)", q: "åŠ åƒ¹ç†±æ½® è¨±å† å‚‘", msg: "è¼•é¬†ä¸€ä¸‹ï¼Œç¬‘çœ‹äººç”Ÿï¼" },
                    { t: "é¬¼é¦¬é›™æ˜Ÿ", a: "è¨±å† å‚‘ (Samuel Hui)", q: "é¬¼é¦¬é›™æ˜Ÿ è¨±å† å‚‘", msg: "é¬¼é¦¬å¾—æ„ï¼Œé–‹å¿ƒéæ—¥è¾°ã€‚" },
                    { t: "ä½›è·³ç‰†", a: "è¨±å† å‚‘ (Samuel Hui)", q: "ä½›è·³ç‰† è¨±å† å‚‘", msg: "å’ªå’é•·æ°£ï¼Œç¬‘ä¸‹å•¦ï¼" },
                    { t: "éŒ¢éŒ¢éŒ¢", a: "è¨±å† å‚‘ (Samuel Hui)", q: "éŒ¢éŒ¢éŒ¢ è¨±å† å‚‘", msg: "å¹½é»˜ä¸€ä¸‹ï¼Œå””å¥½å’èªçœŸã€‚" },
                    { t: "å­¸ç”Ÿå“¥", a: "è¨±å† å‚‘ (Samuel Hui)", q: "å­¸ç”Ÿå“¥ è¨±å† å‚‘", msg: "å›å‘³ä¸‹é’æ˜¥ï¼Œè¼•é¬†å¾—æ„ã€‚" },
                    { t: "è³£èº«å¥‘", a: "è¨±å† å‚‘ (Samuel Hui)", q: "è³£èº«å¥‘ è¨±å† å‚‘", msg: "è˜‡è¦ä»”å””é§›é©šï¼Œç¬‘ä¸‹å°±éï¼" },
                    { t: "å°–æ²™å’€Susie", a: "è¨±å† å‚‘ (Samuel Hui)", q: "å°–æ²™å’€Susie è¨±å† å‚‘", msg: "è¼•é¬†é¬¼é¦¬ï¼Œè½å®Œå¿ƒæƒ…å¥½ï¼" },
                    { t: "ä¸–ç•ŒçœŸç´°å°", a: "å…’æ­Œ", q: "ä¸–ç•ŒçœŸç´°å° å…’æ­Œ", msg: "äººäººå¸¸æ­¡ç¬‘ï¼Œä¸è¦çœ¼æ·šæ‰ï¼" },
                    { t: "åŠæ–¤å…«å…©", a: "è¨±å† å‚‘ (Samuel Hui)", q: "åŠæ–¤å…«å…© è¨±å† å‚‘", msg: "æˆ‘ä¹ŸåŠæ–¤ï¼Œä½ ä¹Ÿå…«å…©ï¼" }
                ],
                'cool': [
                    { t: "æ¼«æ­¥äººç”Ÿè·¯", a: "é„§éº—å› (Teresa Teng)", q: "æ¼«æ­¥äººç”Ÿè·¯ é„§éº—å›", msg: "æ…¢æ…¢è¡Œï¼Œæ¬£è³æ²¿é€”é¢¨æ™¯ã€‚" },
                    { t: "é¢¨ç¹¼çºŒå¹", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "é¢¨ç¹¼çºŒå¹ å¼µåœ‹æ¦®", msg: "æŸ”æƒ…ä¼¼æ°´ï¼Œäº«å—ç•¶ä¸‹ã€‚" },
                    { t: "éš¨æƒ³æ›²", a: "å¾å°é³³ (Paula Tsui)", q: "éš¨æƒ³æ›² å¾å°é³³", msg: "éš¨å¿ƒæ‰€æ¬²ï¼Œä¾¿æ˜¯å¿«æ¨‚ã€‚" },
                    { t: "ä¸ç¾ˆçš„é¢¨", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "ä¸ç¾ˆçš„é¢¨ å¼µåœ‹æ¦®", msg: "å¹å‡ºä½ çš„ç†±æƒ…ï¼Œç€Ÿç‘è‡ªåœ¨ã€‚" },
                    { t: "ç€Ÿç‘èµ°ä¸€å›", a: "è‘‰è’¨æ–‡ (Sally Yeh)", q: "ç€Ÿç‘èµ°ä¸€å› è‘‰è’¨æ–‡", msg: "åšäººè¦ç€Ÿç‘ï¼Œä½•å¿…å¤ªè¨ˆè¼ƒã€‚" },
                    { t: "ç¨è‡ªå»å·æ­¡", a: "åŠ‰å¾·è¯ (Andy Lau)", q: "ç¨è‡ªå»å·æ­¡ åŠ‰å¾·è¯", msg: "äº«å—è‡ªå·±çš„æ™‚é–“ï¼Œè¼•é¬†è‡ªåœ¨ã€‚" },
                    { t: "èˆŠå¤¢ä¸é ˆè¨˜", a: "é›·å®‰å¨œ (Annabelle Lui)", q: "èˆŠå¤¢ä¸é ˆè¨˜ é›·å®‰å¨œ", msg: "éš¨é¢¨è€Œå»ï¼Œè¼•é¬†è‡ªåœ¨ã€‚" },
                    { t: "é¢¨é›¨åŒè·¯", a: "å¾å°é³³ (Paula Tsui)", q: "é¢¨é›¨åŒè·¯ å¾å°é³³", msg: "ç„¡è«–é¢¨é›¨ï¼Œä¾ç„¶ç€Ÿç‘ã€‚" },
                    { t: "å…‰é™°çš„æ•…äº‹", a: "ç¾…å¤§ä½‘", q: "å…‰é™°çš„æ•…äº‹ ç¾…å¤§ä½‘", msg: "æµæ°´å¸¶èµ°å…‰é™°çš„æ•…äº‹ï¼Œæˆ‘å€‘ä¾ç„¶å¹´è¼•ã€‚" },
                    { t: "ç”œèœœèœœ", a: "é„§éº—å› (Teresa Teng)", q: "ç”œèœœèœœ é„§éº—å›", msg: "å¿ƒæƒ…å¥½ä¼¼é£Ÿå’—ç³–å’ç”œã€‚" }
                ],
                'calm': [
                    { t: "æµªå­å¿ƒè²", a: "è¨±å† å‚‘ (Samuel Hui)", q: "æµªå­å¿ƒè² è¨±å† å‚‘", msg: "å¿ƒå¢ƒå¹³å’Œï¼Œå‘½è£¡æœ‰æ™‚çµ‚é ˆæœ‰ã€‚" },
                    { t: "é™Œä¸Šæ­¸äºº", a: "å€ç‘å¼· (Albert Au)", q: "é™Œä¸Šæ­¸äºº å€ç‘å¼·", msg: "å›æ­¸è‡ªç„¶ï¼Œå¿ƒæ› ç¥æ€¡ã€‚" },
                    { t: "è·èŠ±é¦™", a: "æ—å­ç¥¥ (George Lam)", q: "è·èŠ±é¦™ æ—å­ç¥¥", msg: "æ·¡æ·¡å¹½æƒ…ï¼Œå¿ƒå¢ƒå¹³éœã€‚" },
                    { t: "æ¼£æ¼ª", a: "é™³ç™¾å¼· (Danny Chan)", q: "æ¼£æ¼ª é™³ç™¾å¼·", msg: "éœè½å¿ƒè²ï¼Œå¦‚æ°´èˆ¬æ¸…æ¾ˆã€‚" },
                    { t: "ä¼¼æ°´æµå¹´", a: "æ¢…è‰·èŠ³ (Anita Mui)", q: "ä¼¼æ°´æµå¹´ æ¢…è‰·èŠ³", msg: "å¤–è²Œæ—©æ”¹è®Šï¼Œè™•å¢ƒéƒ½è®Šï¼Œæƒ…æ‡·æœªè®Šã€‚" },
                    { t: "éµå¡”å‡Œé›²", a: "è¨±å† å‚‘ (Samuel Hui)", q: "éµå¡”å‡Œé›² è¨±å† å‚‘", msg: "å›é¦–å¾€äº‹ï¼Œå¿ƒå¢ƒå®‰è©³ã€‚" },
                    { t: "åœ¨æ°´ä¸­å¤®", a: "æ—å­ç¥¥ (George Lam)", q: "åœ¨æ°´ä¸­å¤® æ—å­ç¥¥", msg: "éœéœåœ°è½ï¼Œäº«å—é€™ä¸€åˆ»ã€‚" },
                    { t: "æ¼èˆŸå”±æ™š", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "æ¼èˆŸå”±æ™š é—œæ­£å‚‘", msg: "å¤•é™½è¥¿ä¸‹ï¼Œå¿ƒå¢ƒå¹³å’Œã€‚" },
                    { t: "ç›¸æ€æ²³ç•”", a: "é™³ç™¾å¼· (Danny Chan)", q: "ç›¸æ€æ²³ç•” é™³ç™¾å¼·", msg: "æŸ”æŸ”çš„é¢¨ï¼Œè¼•è¼•çš„å¤¢ã€‚" },
                    { t: "ä»Šå®µå¤šçé‡", a: "é™³ç™¾å¼· (Danny Chan)", q: "ä»Šå®µå¤šçé‡ é™³ç™¾å¼·", msg: "æ”¾ä¸‹ç…©æƒ±ï¼Œå¥½å¥½ä¼‘æ¯ã€‚" }
                ],
                'grateful': [
                    { t: "å¿µè¦ªæ©", a: "é™³ç™¾å¼· (Danny Chan)", q: "å¿µè¦ªæ© é™³ç™¾å¼·", msg: "é£²æ°´æ€æºï¼Œå¿ƒä¸­å¯Œæœ‰ã€‚" },
                    { t: "çˆ¶æ¯æ©", a: "è¨±å† å‚‘ (Samuel Hui)", q: "çˆ¶æ¯æ© è¨±å† å‚‘", msg: "è¦ªæ©æ·±ä¼¼æµ·ï¼Œå¸¸æ‡·æ„Ÿæ©å¿ƒã€‚" },
                    { t: "ç¥ç¦", a: "è‘‰è’¨æ–‡ (Sally Yeh)", q: "ç¥ç¦ è‘‰è’¨æ–‡", msg: "é€çµ¦ä½ æœ€çœŸæ‘¯çš„ç¥ç¦ã€‚" },
                    { t: "çœŸçš„æ„›ä½ ", a: "Beyond", q: "çœŸçš„æ„›ä½  Beyond", msg: "æ„Ÿè¬è¦ªæ©ï¼Œæ¯æ„›æœ€å‰å¤§ã€‚" },
                    { t: "å–é‡‡", a: "é™³ç™¾å¼· (Danny Chan)", q: "å–é‡‡ é™³ç™¾å¼·", msg: "ç‚ºè‡ªå·±å–é‡‡ï¼Œæ„Ÿæ©æ“æœ‰çš„ä¸€åˆ‡ã€‚" },
                    { t: "æ†‘è‘—æ„›", a: "è˜‡èŠ® (Julie Sue)", q: "æ†‘è‘—æ„› è˜‡èŠ®", msg: "æ†‘è‘—æ„›ï¼Œæˆ‘ä¿¡æœ‰å‡ºè·¯ã€‚" },
                    { t: "ä¸–ä¸Šåªæœ‰åª½åª½å¥½", a: "å…’æ­Œ", q: "ä¸–ä¸Šåªæœ‰åª½åª½å¥½", msg: "æœ‰åª½çš„å­©å­åƒå€‹å¯¶ï¼Œæ„Ÿæ©æœ‰æ‚¨ã€‚" },
                    { t: "æœ‹å‹", a: "è­šè© éºŸ (Alan Tam)", q: "æœ‹å‹ è­šè© éºŸ", msg: "äººç”Ÿå¦‚å¤¢ï¼Œæœ‹å‹å¦‚éœ§ï¼Œæ„Ÿæ©æœ‰ä½ ã€‚" },
                    { t: "æ„Ÿæ¿€", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "æ„Ÿæ¿€ å¼µåœ‹æ¦®", msg: "æ„Ÿæ¿€æ¯ä¸€ä½å¹«åŠ©éæˆ‘çš„äººã€‚" },
                    { t: "æ„›åœ¨æ·±ç§‹", a: "è­šè© éºŸ (Alan Tam)", q: "æ„›åœ¨æ·±ç§‹ è­šè© éºŸ", msg: "æ„Ÿæ©æœ‰æ„›ï¼Œæº«æš–åœ¨å¿ƒé ­ã€‚" }
                ],
                'loved': [
                    { t: "åˆ†åˆ†é˜éœ€è¦ä½ ", a: "æ—å­ç¥¥ (George Lam)", q: "åˆ†åˆ†é˜éœ€è¦ä½  æ—å­ç¥¥", msg: "æœ‰äººéŒ«ä¿‚æœ€å¹¸ç¦å˜…ï¼" },
                    { t: "ç”œèœœèœœ", a: "é„§éº—å› (Teresa Teng)", q: "ç”œèœœèœœ é„§éº—å›", msg: "ç”œç”œèœœèœœï¼Œå¿ƒä¸­æº«æš–ã€‚" },
                    { t: "æœˆäº®ä»£è¡¨æˆ‘çš„å¿ƒ", a: "é„§éº—å› (Teresa Teng)", q: "æœˆäº®ä»£è¡¨æˆ‘çš„å¿ƒ é„§éº—å›", msg: "æ„›æ„æ»¿æ»¿ï¼Œå¸¸åœ¨å¿ƒé–“ã€‚" },
                    { t: "é›™æ˜Ÿæƒ…æ­Œ", a: "è¨±å† å‚‘ (Samuel Hui)", q: "é›™æ˜Ÿæƒ…æ­Œ è¨±å† å‚‘", msg: "å¿ƒå¿ƒç›¸å°ï¼Œæ„›æ„æ¿ƒã€‚" },
                    { t: "é™ªè‘—ä½ èµ°", a: "ç›§å† å»· (Lowell Lo)", q: "é™ªè‘—ä½ èµ° ç›§å† å»·", msg: "ä¸€ç”Ÿä¸€ä¸–ï¼Œé™ªè‘—ä½ èµ°ã€‚" },
                    { t: "ç‚ºä½ é¾æƒ…", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "ç‚ºä½ é¾æƒ… å¼µåœ‹æ¦®", msg: "é¾æƒ…æ–¼ä½ ï¼Œæ­¤ç”Ÿä¸è®Šã€‚" },
                    { t: "ä½ çš„çœ¼ç¥", a: "æ—å¿—ç¾ (Samantha Lam)", q: "ä½ çš„çœ¼ç¥ æ—å¿—ç¾", msg: "æ„›åœ¨ä¸è¨€ä¸­ï¼Œçœ¼ç¥å·²è¶³å¤ ã€‚" },
                    { t: "å¶é‡", a: "æ—å¿—ç¾ (Samantha Lam)", q: "å¶é‡ æ—å¿—ç¾", msg: "ç·£ä»½åˆ°äº†ï¼Œä¾¿è¦çæƒœã€‚" },
                    { t: "å–œæ­¡ä½ ", a: "Beyond", q: "å–œæ­¡ä½  Beyond", msg: "ç°¡ç°¡å–®å–®ä¸€å¥å–œæ­¡ä½ ï¼Œå‹éåƒè¨€è¬èªã€‚" },
                    { t: "ä¸€ç”Ÿä½•æ±‚", a: "é™³ç™¾å¼· (Danny Chan)", q: "ä¸€ç”Ÿä½•æ±‚ é™³ç™¾å¼·", msg: "ä¸€ç”Ÿä½•æ±‚ï¼Œæœ‰æ„›è¶³çŸ£ã€‚" }
                ],
                'thinking': [
                    { t: "ç…å­å±±ä¸‹", a: "ç¾…æ–‡ (Roman Tam)", q: "ç…å­å±±ä¸‹ ç¾…æ–‡", msg: "äººç”Ÿä¸å…å´å¶‡ï¼Œå¤§å®¶åŒèˆŸå…±æ¿Ÿã€‚" },
                    { t: "æ¯ç•¶è®Šå¹»æ™‚", a: "è–°å¦® (Fanny Wang)", q: "æ¯ç•¶è®Šå¹»æ™‚ è–°å¦®", msg: "éŸ¶è¯å»ï¼Œæ‡·å¿µå¾€äº‹ï¼Œçæƒœç¾åœ¨ã€‚" },
                    { t: "å¹¾è¨±é¢¨é›¨", a: "ç¾…æ–‡ (Roman Tam)", q: "å¹¾è¨±é¢¨é›¨ ç¾…æ–‡", msg: "çœ‹é€ä¸–äº‹ï¼Œç„¡æ„§æ–¼å¿ƒã€‚" },
                    { t: "å…‰è¼æ­²æœˆ", a: "Beyond", q: "å…‰è¼æ­²æœˆ Beyond", msg: "ä¸€ç”Ÿç¶“éå¾¬å¾¨çš„æ™æ‰ï¼Œè‡ªä¿¡å¯æ”¹è®Šæœªä¾†ã€‚" },
                    { t: "äººç”Ÿä½•è™•ä¸ç›¸é€¢", a: "é™³æ…§å«» (Priscilla Chan)", q: "äººç”Ÿä½•è™•ä¸ç›¸é€¢ é™³æ…§å«»", msg: "ç›¸é€¢å³æ˜¯æœ‰ç·£ï¼Œéš¨ç·£è‡ªåœ¨ã€‚" },
                    { t: "æ„Ÿæƒ…çš„æ®µè½", a: "æ—å­ç¥¥ (George Lam)", q: "æ„Ÿæƒ…çš„æ®µè½ æ—å­ç¥¥", msg: "å›å‘³äººç”Ÿé»æ»´ï¼Œç´°æ°´é•·æµã€‚" },
                    { t: "é †æµé€†æµ", a: "å¾å°é³³ (Paula Tsui)", q: "é †æµé€†æµ å¾å°é³³", msg: "äººç”Ÿæœ‰èµ·æœ‰è½ï¼Œå¹³å¸¸å¿ƒé¢å°ã€‚" },
                    { t: "æŠ‰æ“‡", a: "æ—å­ç¥¥ (George Lam)", q: "æŠ‰æ“‡ æ—å­ç¥¥", msg: "äººç”Ÿå……æ»¿æŠ‰æ“‡ï¼Œç›¸ä¿¡è‡ªå·±çš„ç›´è¦ºã€‚" },
                    { t: "æ˜Ÿ", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "æ˜Ÿ é—œæ­£å‚‘", msg: "é–‰ä¸Šçœ¼ï¼Œè½è½æ˜Ÿçš„è²éŸ³ã€‚" },
                    { t: "å¤§åœ°", a: "Beyond", q: "å¤§åœ° Beyond", msg: "å›æœ›éå»ï¼Œå±•æœ›å°‡ä¾†ã€‚" }
                ],
                'tired': [
                    { t: "é¢¨é›¨åŒè·¯", a: "å¾å°é³³ (Paula Tsui)", q: "é¢¨é›¨åŒè·¯ å¾å°é³³", msg: "ä¼‘æ¯ä¸‹ï¼Œè½é¦–æ­Œæ”¾é¬†å¿ƒæƒ…ã€‚" },
                    { t: "å€¦", a: "è‘‰å¾·å«» (Deanie Ip)", q: "å€¦ è‘‰å¾·å«»", msg: "å€¦äº†å—ï¼Ÿé–‰ä¸Šçœ¼ä¼‘æ¯ä¸€æœƒå§ã€‚" },
                    { t: "èŠèŒµæ²³ä¹‹æˆ€", a: "éº¥æ½”æ–‡ (Kitman Mak)", q: "èŠèŒµæ²³ä¹‹æˆ€ éº¥æ½”æ–‡", msg: "è½è½æŸ”å’ŒéŸ³æ¨‚ï¼Œèˆ’ç·©ç–²å‹ã€‚" },
                    { t: "ç„¡å¥ˆ", a: "å¾å°é³³ (Paula Tsui)", q: "ç„¡å¥ˆ å¾å°é³³", msg: "æ”¾ä¸‹ç…©æƒ±ï¼Œè½è½æ­Œï¼Œç¡å€‹å¥½è¦ºã€‚" },
                    { t: "å„‚æœ¬å¤šæƒ…", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "å„‚æœ¬å¤šæƒ… å¼µåœ‹æ¦®", msg: "æ·±æƒ…æ¼”ç¹¹ï¼Œæ’«æ…°å¿ƒéˆã€‚" },
                    { t: "æ™šé¢¨", a: "è‘‰è’¨æ–‡ (Sally Yeh)", q: "æ™šé¢¨ è‘‰è’¨æ–‡", msg: "æ™šé¢¨è¼•è¼•å¹ï¼Œå¸¶èµ°ä½ çš„ç–²ç´¯ã€‚" },
                    { t: "å¹¸é‹æ˜¯æˆ‘", a: "è‘‰å¾·å«» (Deanie Ip)", q: "å¹¸é‹æ˜¯æˆ‘ è‘‰å¾·å«»", msg: "ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·çš„è·¯ã€‚" },
                    { t: "æ˜æ˜Ÿ", a: "è‘‰å¾·å«» (Deanie Ip)", q: "æ˜æ˜Ÿ è‘‰å¾·å«»", msg: "éœéœåœ°è½ï¼Œè®“æ˜Ÿæ˜Ÿå®ˆè­·ä½ ã€‚" },
                    { t: "é›¶æ™‚ååˆ†", a: "è‘‰è’¨æ–‡ (Sally Yeh)", q: "é›¶æ™‚ååˆ† è‘‰è’¨æ–‡", msg: "å¤œæ·±äº†ï¼Œå¥½å¥½ä¼‘æ¯ã€‚" },
                    { t: "é¡˜", a: "æ—æ†¶è“® (Sandy Lam)", q: "é¡˜ æ—æ†¶è“®", msg: "é¡˜ä½ ä»Šæ™šæœ‰å¥½å¤¢ã€‚" }
                ],
                'confused': [
                    { t: "å•æˆ‘", a: "é™³éº—æ–¯ (Chelsea Chan)", q: "å•æˆ‘ é™³éº—æ–¯", msg: "ç¬‘ç¬‘å£ï¼Œä¸ç”¨å¤ªæ“”æ†‚ï¼Œéš¨é‡è€Œå®‰ã€‚" },
                    { t: "è«å†æ‚²", a: "æ—å­ç¥¥ (George Lam)", q: "è«å†æ‚² æ—å­ç¥¥", msg: "æŠ¹ä¹¾çœ¼æ·šï¼Œå‰é¢é¢¨æ™¯æ›´ç¾ã€‚" },
                    { t: "é›£å¾—ç³Šå¡—", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "é›£å¾—ç³Šå¡— é—œæ­£å‚‘", msg: "äººç”Ÿé›£å¾—ç³Šå¡—ï¼Œæ”¾é–‹æ‡·æŠ±ã€‚" },
                    { t: "å¤©æ‰ç™½ç—´å¤¢", a: "è¨±å† å‚‘ (Samuel Hui)", q: "å¤©æ‰ç™½ç—´å¤¢ è¨±å† å‚‘", msg: "å¤©é€ ä¹‹æï¼Œçš†æœ‰å…¶ç”¨ã€‚" },
                    { t: "æ‰¾ä¸è‘—è—‰å£", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "æ‰¾ä¸è‘—è—‰å£ è‘‰æŒ¯æ£ ", msg: "æœ‰äº›äº‹ï¼Œä¸ç”¨å¤ªåŸ·è‘—ã€‚" },
                    { t: "é †æµé€†æµ", a: "å¾å°é³³ (Paula Tsui)", q: "é †æµé€†æµ å¾å°é³³", msg: "é †æµé€†æµï¼Œéƒ½æ˜¯äººç”Ÿå¿…ç¶“ä¹‹è·¯ã€‚" },
                    { t: "è®Šè‰²é¾", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "è®Šè‰²é¾ é—œæ­£å‚‘", msg: "ä¸–ç•Œåœ¨è®Šï¼Œå¿ƒå¢ƒè¦å®šã€‚" },
                    { t: "ä¸€æ°´éš”å¤©æ¶¯", a: "é„§éº—å› (Teresa Teng)", q: "ä¸€æ°´éš”å¤©æ¶¯ é„§éº—å›", msg: "çœ‹é–‹ä¸€é»ï¼Œç…©æƒ±è‡ªç„¶å°‘ã€‚" },
                    { t: "å¿˜ç›¡å¿ƒä¸­æƒ…", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "å¿˜ç›¡å¿ƒä¸­æƒ… è‘‰æŒ¯æ£ ", msg: "å¿˜è¨˜éå»ï¼Œé‡æ–°é–‹å§‹ã€‚" },
                    { t: "æˆ²åŠ‡äººç”Ÿ", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "æˆ²åŠ‡äººç”Ÿ è‘‰æŒ¯æ£ ", msg: "äººç”Ÿå¦‚æˆ²ï¼Œä½•å¿…å¤ªèªçœŸã€‚" }
                ],
                'surprised': [
                    { t: "ä¸–äº‹å¦‚æ£‹", a: "è¨±å† å‚‘ (Samuel Hui)", q: "ä¸–äº‹å¦‚æ£‹ è¨±å† å‚‘", msg: "ä¸–äº‹å¦‚æ£‹å±€å±€æ–°ï¼Œå¹³å¸¸å¿ƒå°å¾…ã€‚" },
                    { t: "è®Š", a: "è‘‰å¾·å«» (Deanie Ip)", q: "è®Š è‘‰å¾·å«»", msg: "ä¸–ç•Œåœ¨è®Šï¼Œå”¯æœ‰å¿ƒä¸è®Šã€‚" },
                    { t: "æˆ²åŠ‡äººç”Ÿ", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "æˆ²åŠ‡äººç”Ÿ è‘‰æŒ¯æ£ ", msg: "äººç”Ÿå¦‚æˆ²ï¼Œä½•å¿…å¤ªåŸ·è‘—ã€‚" },
                    { t: "å¤©è ¶è®Š", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "å¤©è ¶è®Š é—œæ­£å‚‘", msg: "å†èˆ‡å¤©æ¯”é«˜ï¼Œä¸–äº‹å¸¸è®Šã€‚" },
                    { t: "è®Šè‰²é¾", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "è®Šè‰²é¾ é—œæ­£å‚‘", msg: "äººç”Ÿéš›é‡ï¼Œè®Šå¹»è«æ¸¬ã€‚" },
                    { t: "æ›åˆ°åƒèˆ¬æ¨", a: "æŸ³å½±è™¹ (Willow Belle)", q: "æ›åˆ°åƒèˆ¬æ¨ æŸ³å½±è™¹", msg: "æ„›æ¨æƒ…ä»‡ï¼Œè½‰çœ¼é›²ç…™ã€‚" },
                    { t: "è¼ªæµè½‰", a: "é„­å°‘ç§‹ (Adam Cheng)", q: "è¼ªæµè½‰ é„­å°‘ç§‹", msg: "é¢¨æ°´è¼ªæµè½‰ï¼Œç¸½æœ‰å‡ºé ­å¤©ã€‚" },
                    { t: "é±·é­šæ·š", a: "è¢éº—å«¦ (Lisa Yuen)", q: "é±·é­šæ·š è¢éº—å«¦", msg: "ä¸–äº‹é›£æ–™ï¼Œä¿æŒé®å®šã€‚" },
                    { t: "å¤§å…§ç¾¤è‹±", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "å¤§å…§ç¾¤è‹± è‘‰æŒ¯æ£ ", msg: "ç¬‘çœ‹é¢¨é›²ï¼Œè™•è®Šä¸é©šã€‚" },
                    { t: "äººåœ¨æ—…é€”ç‘æ·šæ™‚", a: "é—œæ­£å‚‘ é›·å®‰å¨œ", q: "äººåœ¨æ—…é€”ç‘æ·šæ™‚ é—œæ­£å‚‘", msg: "äººç”Ÿæ—…é€”ï¼Œç¸½æœ‰é©šå–œã€‚" }
                ],
                'sick': [
                    { t: "è¬æ°´åƒå±±ç¸½æ˜¯æƒ…", a: "æ±ªæ˜èƒ (Liza Wang)", q: "è¬æ°´åƒå±±ç¸½æ˜¯æƒ… æ±ªæ˜èƒ", msg: "ä¿é‡èº«é«”ï¼Œå¤šé£²æ°´ï¼Œè½é¦–æº«æŸ”å˜…æ­Œã€‚" },
                    { t: "æ†‘è‘—æ„›", a: "è˜‡èŠ® (Julie Sue)", q: "æ†‘è‘—æ„› è˜‡èŠ®", msg: "æ†‘è‘—æ„›ï¼Œæˆ‘å€‘æœƒå¥½èµ·ä¾†çš„ã€‚" },
                    { t: "é¡˜", a: "æ—æ†¶è“® (Sandy Lam)", q: "é¡˜ æ—æ†¶è“®", msg: "é¡˜ä½ å¹³å®‰ï¼Œæ—©æ—¥åº·å¾©ã€‚" },
                    { t: "æ˜å¤©æœƒæ›´å¥½", a: "ç¾¤æ˜Ÿ", q: "æ˜å¤©æœƒæ›´å¥½ ç¾¤æ˜Ÿ", msg: "æ˜å¤©æœƒæ›´å¥½ï¼ŒåŠ æ²¹ï¼" },
                    { t: "å…±åŒæ¸¡é", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "å…±åŒæ¸¡é å¼µåœ‹æ¦®", msg: "æ²’ä»€éº¼éä¸å»çš„ï¼Œæˆ‘å€‘å…±åŒæ¸¡éã€‚" },
                    { t: "ç¥ç¦", a: "è‘‰è’¨æ–‡ (Sally Yeh)", q: "ç¥ç¦ è‘‰è’¨æ–‡", msg: "é€ä¸Šæœ€æš–çš„ç¥ç¦ï¼Œæ—©æ—¥åº·å¾©ã€‚" },
                    { t: "æ¯æ—¥æ‡·å¿µä½ ", a: "å¾å°é³³ (Paula Tsui)", q: "æ¯æ—¥æ‡·å¿µä½  å¾å°é³³", msg: "æ”¾é¬†å¿ƒæƒ…ï¼Œå¥½å¿«å¥½è¿”ã€‚" },
                    { t: "æŠ±ç·Šçœ¼å‰äºº", a: "æ¢…è‰·èŠ³ (Anita Mui)", q: "æŠ±ç·Šçœ¼å‰äºº æ¢…è‰·èŠ³", msg: "çæƒœçœ¼å‰ï¼Œä¿é‡èº«é«”ã€‚" },
                    { t: "å–é‡‡", a: "é™³ç™¾å¼· (Danny Chan)", q: "å–é‡‡ é™³ç™¾å¼·", msg: "ç‚ºè‡ªå·±æ‰“æ°£ï¼Œä½ åšå¾—åˆ°ï¼" },
                    { t: "æ¯ä¸€å€‹æ™šä¸Š", a: "æ—å­ç¥¥ (George Lam)", q: "æ¯ä¸€å€‹æ™šä¸Š æ—å­ç¥¥", msg: "å¥½å¥½ä¼‘æ¯ï¼Œæ˜å¤©æœƒæ›´å¥½ã€‚" }
                ],
                'anxious': [
                    { t: "æ²‰é»˜æ˜¯é‡‘", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "æ²‰é»˜æ˜¯é‡‘ å¼µåœ‹æ¦®", msg: "æ”¾é¬†å¿ƒæƒ…ï¼Œç¬‘ç½µç”±äººï¼Œç‘è„«å•²ã€‚" },
                    { t: "å¿˜ç›¡å¿ƒä¸­æƒ…", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "å¿˜ç›¡å¿ƒä¸­æƒ… è‘‰æŒ¯æ£ ", msg: "å¿˜è¨˜ç…©æƒ±ï¼Œå¿ƒå¢ƒè‡ªç„¶é–‹æœ—ã€‚" },
                    { t: "ä¸€é»ç‡­å…‰", a: "é—œæ­£å‚‘ (Michael Kwan)", q: "ä¸€é»ç‡­å…‰ é—œæ­£å‚‘", msg: "ç‡ƒäº®å¿ƒä¸­å¸Œæœ›ï¼Œä¸ç”¨æ€•ã€‚" },
                    { t: "å¿ƒå‚µ", a: "æ¢…è‰·èŠ³ (Anita Mui)", q: "å¿ƒå‚µ æ¢…è‰·èŠ³", msg: "çœ‹é–‹ä¸€é»ï¼Œå¿ƒæƒ…è‡ªç„¶å¥½ã€‚" },
                    { t: "äº¤å‡ºæˆ‘çš„å¿ƒ", a: "æ¢…è‰·èŠ³ (Anita Mui)", q: "äº¤å‡ºæˆ‘çš„å¿ƒ æ¢…è‰·èŠ³", msg: "ç›¸ä¿¡è‡ªå·±ï¼Œä¸€åˆ‡æœƒé †åˆ©ã€‚" },
                    { t: "æ¼«æ­¥äººç”Ÿè·¯", a: "é„§éº—å› (Teresa Teng)", q: "æ¼«æ­¥äººç”Ÿè·¯ é„§éº—å›", msg: "æ…¢æ…¢èµ°ï¼Œä¸ç”¨æ€¥ï¼Œè·¯ä¸€ç›´éƒ½åœ¨ã€‚" },
                    { t: "è«å†æ‚²", a: "æ—å­ç¥¥ (George Lam)", q: "è«å†æ‚² æ—å­ç¥¥", msg: "æ·±å‘¼å¸ï¼Œæ”¾é¬†å¿ƒæƒ…ã€‚" },
                    { t: "å¥®é¬¥", a: "ç”„å¦® (Jenny Tseng)", q: "å¥®é¬¥ ç”„å¦®", msg: "é‡åˆ°å›°é›£ï¼Œæ›´è¦å …å¼·ã€‚" },
                    { t: "å¼·äºº", a: "ç¾…æ–‡ (Roman Tam)", q: "å¼·äºº ç¾…æ–‡", msg: "ä½ æ˜¯å¼·äººï¼Œä¸€å®šæ‡‰ä»˜å¾—ä¾†ã€‚" },
                    { t: "ç¬‘çœ‹é¢¨é›²", a: "é„­å°‘ç§‹ (Adam Cheng)", q: "ç¬‘çœ‹é¢¨é›² é„­å°‘ç§‹", msg: "ç¬‘ä¸€ç¬‘ï¼Œä¸–ç•Œæ›´ç¾å¦™ã€‚" }
                ],
                'sad': [
                    { t: "é †æµé€†æµ", a: "å¾å°é³³ (Paula Tsui)", q: "é †æµé€†æµ å¾å°é³³", msg: "ä¸å¿«æ¨‚æ™‚ï¼Œè½é¦–æ­Œè§£åƒæ„ï¼Œè½æ—¥æœƒæ›´å¥½ã€‚" },
                    { t: "æœ‰èª°å…±é³´", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "æœ‰èª°å…±é³´ å¼µåœ‹æ¦®", msg: "å­¤å–®ä¸è¦ç·Šï¼Œæ­Œè²é™ªä¼´ä½ ã€‚" },
                    { t: "é¢¨é›¨åŒè·¯", a: "å¾å°é³³ (Paula Tsui)", q: "é¢¨é›¨åŒè·¯ å¾å°é³³", msg: "é¢¨é›¨éå¾Œè¦‹å½©è™¹ï¼ŒåŠ æ²¹ï¼" },
                    { t: "ååå–œæ­¡ä½ ", a: "é™³ç™¾å¼· (Danny Chan)", q: "ååå–œæ­¡ä½  é™³ç™¾å¼·", msg: "æ‡·å¿µéå»ï¼Œä¹Ÿæ˜¯ä¸€ç¨®ç¾ã€‚" },
                    { t: "ä¼¼æ˜¯æ•…äººä¾†", a: "æ¢…è‰·èŠ³ (Anita Mui)", q: "ä¼¼æ˜¯æ•…äººä¾† æ¢…è‰·èŠ³", msg: "ç·£ä»½æœªç›¡ï¼Œç¸½æœƒé‡é€¢ã€‚" },
                    { t: "åƒåƒé—‹æ­Œ", a: "é™³æ…§å«» (Priscilla Chan)", q: "åƒåƒé—‹æ­Œ é™³æ…§å«»", msg: "æ­¤åˆ»çš„æ„Ÿå‹•ï¼Œæ°¸é ç•™åœ¨å¿ƒä¸­ã€‚" },
                    { t: "ä¸€èµ·èµ°éçš„æ—¥å­", a: "åŠ‰å¾·è¯ (Andy Lau)", q: "ä¸€èµ·èµ°éçš„æ—¥å­ åŠ‰å¾·è¯", msg: "é›–ç„¶è¾›è‹¦ï¼Œä½†æˆ‘å€‘ä¸€èµ·èµ°éã€‚" },
                    { t: "ç¥ç¦", a: "è‘‰è’¨æ–‡ (Sally Yeh)", q: "ç¥ç¦ è‘‰è’¨æ–‡", msg: "é€ä¸Šç¥ç¦ï¼Œé¡˜ä½ å¿«æ¨‚ã€‚" },
                    { t: "æ†‘è‘—æ„›", a: "è˜‡èŠ® (Julie Sue)", q: "æ†‘è‘—æ„› è˜‡èŠ®", msg: "æ„›åœ¨å¿ƒä¸­ï¼Œä¸å†å­¤å–®ã€‚" },
                    { t: "æ²‰é»˜æ˜¯é‡‘", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "æ²‰é»˜æ˜¯é‡‘ å¼µåœ‹æ¦®", msg: "å“­å‡ºä¾†æœƒèˆ’æœé»ï¼Œä¹‹å¾Œå†ç¬‘ã€‚" }
                ],
                'angry': [
                    { t: "æ»„æµ·ä¸€è²ç¬‘", a: "è¨±å† å‚‘ (Samuel Hui)", q: "æ»„æµ·ä¸€è²ç¬‘ è¨±å† å‚‘", msg: "æ·±å‘¼å¸ï¼Œç¬‘ä¸€ç¬‘ä¸–ç•Œæ›´ç¾ã€‚" },
                    { t: "éµè¡€ä¸¹å¿ƒ", a: "ç¾…æ–‡ ç”„å¦®", q: "éµè¡€ä¸¹å¿ƒ ç¾…æ–‡ ç”„å¦®", msg: "è½é¦–æ¿€æ˜‚å˜…æ­Œï¼Œç™¼æ´©ä¸‹æƒ…ç·’ï¼" },
                    { t: "å¤§ä¿ éœå…ƒç”²", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "å¤§ä¿ éœå…ƒç”² è‘‰æŒ¯æ£ ", msg: "åšäººè¦æœ‰æ°£é‡ï¼Œé€€ä¸€æ­¥æµ·é—Šå¤©ç©ºã€‚" },
                    { t: "èª“è¦å…¥åˆ€å±±", a: "é„­å°‘ç§‹ (Adam Cheng)", q: "èª“è¦å…¥åˆ€å±± é„­å°‘ç§‹", msg: "è±ªæ°£å¹²é›²ï¼Œä¸æ‹˜å°ç¯€ï¼" },
                    { t: "æ¥šç•™é¦™", a: "é„­å°‘ç§‹ (Adam Cheng)", q: "æ¥šç•™é¦™ é„­å°‘ç§‹", msg: "åƒå±±æˆ‘ç¨è¡Œï¼Œä¸å¿…ç›¸é€ã€‚" },
                    { t: "ç”·å…’ç•¶è‡ªå¼·", a: "æ—å­ç¥¥ (George Lam)", q: "ç”·å…’ç•¶è‡ªå¼· æ—å­ç¥¥", msg: "æŒºèµ·èƒ¸è†›ï¼Œåšå€‹å¥½æ¼¢ï¼" },
                    { t: "è¬é‡Œé•·åŸæ°¸ä¸å€’", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "è¬é‡Œé•·åŸæ°¸ä¸å€’ è‘‰æŒ¯æ£ ", msg: "å†·éœä¸‹ä¾†ï¼Œä¸è¦è¡å‹•ã€‚" },
                    { t: "éœå…ƒç”²", a: "è‘‰æŒ¯æ£  (Johnny Yip)", q: "éœå…ƒç”² è‘‰æŒ¯æ£ ", msg: "å°‡æ†¤æ€’åŒ–ç‚ºåŠ›é‡ï¼" },
                    { t: "å°æé£›åˆ€", a: "ç¾…æ–‡ (Roman Tam)", q: "å°æé£›åˆ€ ç¾…æ–‡", msg: "æ©æ€¨æƒ…ä»‡ï¼Œä¸€ç¬‘ç½®ä¹‹ã€‚" },
                    { t: "æ›¸åŠæ©ä»‡éŒ„", a: "é„­å°‘ç§‹ (Adam Cheng)", q: "æ›¸åŠæ©ä»‡éŒ„ é„­å°‘ç§‹", msg: "æ”¾é–‹æ‡·æŠ±ï¼Œæµ·é—Šå¤©ç©ºã€‚" }
                ],
                'frustrated': [
                    { t: "å‰ç¨‹éŒ¦ç¹¡", a: "ç¾…æ–‡ (Roman Tam)", q: "å‰ç¨‹éŒ¦ç¹¡ ç¾…æ–‡", msg: "æ–œé™½è£¡æ°£é­„æ›´å£¯ï¼Œå””å¥½ç°å¿ƒï¼" },
                    { t: "å¥®é¬¥", a: "ç”„å¦® (Jenny Tseng)", q: "å¥®é¬¥ ç”„å¦®", msg: "ç„¡è«–æ­·ç›¡å¹¾æ¬¡æµªï¼Œéƒ½è¦å …å¼·ï¼" },
                    { t: "ç´…æ—¥", a: "æå…‹å‹¤ (Hacken Lee)", q: "ç´…æ—¥ æå…‹å‹¤", msg: "å‘½é‹å°±ç®—é¡›æ²›æµé›¢ï¼Œéƒ½è¦ç¹¼çºŒåŠªåŠ›ï¼" },
                    { t: "æ‘˜æ˜Ÿ", a: "é™³ç™¾å¼· (Danny Chan)", q: "æ‘˜æ˜Ÿ é™³ç™¾å¼·", msg: "æˆ‘è¦æ‘˜æ˜Ÿï¼Œä¸èªå‘½ï¼" },
                    { t: "èšŒçš„å•Ÿç¤º", a: "ç¾¤æ˜Ÿ", q: "èšŒçš„å•Ÿç¤º å€ç‘å¼· é—œæ­£å‚‘ ç›§å† å»·", msg: "åªè¦è‚¯åŠªåŠ›ï¼ŒèšŒäº¦èƒ½æˆç ã€‚" },
                    { t: "å§‹çµ‚æœƒè¡Œé‹", a: "å¼µåœ‹æ¦® (Leslie Cheung)", q: "å§‹çµ‚æœƒè¡Œé‹ å¼µåœ‹æ¦®", msg: "æ¨‚è§€é¢å°ï¼Œå¥½é‹è‡ªç„¶ä¾†ã€‚" },
                    { t: "è«å†æ‚²", a: "æ—å­ç¥¥ (George Lam)", q: "è«å†æ‚² æ—å­ç¥¥", msg: "ä¸è¦æ”¾æ£„ï¼Œæ˜å¤©æœƒæ›´å¥½ã€‚" },
                    { t: "å–é‡‡", a: "é™³ç™¾å¼· (Danny Chan)", q: "å–é‡‡ é™³ç™¾å¼·", msg: "ç‚ºè‡ªå·±å–é‡‡ï¼Œä½ æ˜¯æœ€å¥½çš„ï¼" },
                    { t: "å¹¾è¨±é¢¨é›¨", a: "ç¾…æ–‡ (Roman Tam)", q: "å¹¾è¨±é¢¨é›¨ ç¾…æ–‡", msg: "é¢¨é›¨éå¾Œï¼Œæ›´è¦‹å …å¼·ã€‚" },
                    { t: "ç…å­å±±ä¸‹", a: "ç¾…æ–‡ (Roman Tam)", q: "ç…å­å±±ä¸‹ ç¾…æ–‡", msg: "åŒèˆŸå…±æ¿Ÿï¼Œä¸€å®šéåˆ°é›£é—œã€‚" }
                ]
            };

            // Activity Database
            const activityDatabase = {
                'happy': ["æ‰“é›»è©±ä¿¾å­«ä»”å­«å¥³å‚¾åˆ (Call grandchildren)", "å»å…¬åœ’æ•£æ­¥æ›¬å¤ªé™½ (Walk in park)", "ç‡å“èˆŠç›¸ç°¿å›å‘³é–‹å¿ƒäº‹ (Look at photo albums)", "ä¿®å‰ªå“ç›†æ ½ (Light gardening)"],
                'excited': ["å¯«æ—¥è¨˜è¨˜ä½é–‹å¿ƒäº‹ (Write in diary)", "åšç°¡å–®ä¼¸å±•é‹å‹• (Simple stretching)", "åŒæœ‹å‹åˆ†äº«å¥½æ¶ˆæ¯ (Share good news)"],
                'silly': ["ç‡å¥—ç¬‘ç‰‡æˆ–æ­¡æ¨‚ä»Šå®µ (Watch funny video)", "åŒé„°å±…è¬›å€‹ç¬‘è©± (Tell a joke)", "ç•«å¹…å¾—æ„å˜…ç•« (Draw a picture)"],
                'cool': ["å˜†æ¯éšèŒ¶ (Enjoy a cup of tea)", "ç‡å ±ç´™æˆ–è€…æ›¸ (Read newspaper/book)", "åå®šå®šè½æ”¶éŸ³æ©Ÿ (Listen to radio)"],
                'calm': ["æ·±å‘¼å¸éœå (Meditation)", "æ·‹èŠ±æˆ–æ˜¯è§€è³é­šä»” (Water plants/Watch fish)", "é–‰ç›®é¤Šç¥ååˆ†é˜ (Rest eyes)"],
                'grateful': ["å¯«å¼µæ„Ÿè¬å¡ä¿¾è¦ªäºº (Write thank you note)", "å¿ƒä¸­é»˜ç¦±æ„Ÿæ© (Prayer/Reflection)", "æ‰“é›»è©±å•å€™è€å‹ (Call an old friend)"],
                'loved': ["æŠ±å“ç”±å­«ä»”é€å˜…å…¬ä»” (Hug a soft toy)", "ç¹”å†·è¡«æˆ–è€…åšæ‰‹å·¥ (Knitting/Crafts)", "ç‡å“å…¨å®¶ç¦ (Look at family portrait)"],
                'thinking': ["ç©å¡«å­—éŠæˆ²æˆ–è€…æ•¸ç¨ (Sudoku/Crossword)", "åŸ·æ‹¾å“æ«ƒæ¡¶ (Organize a drawer)", "ç‡æ–°èäº†è§£æ™‚äº‹ (Read news)"],
                'tired': ["ç”¨æš–æ°´æµ¸è…³ (Warm foot bath)", "è¨“å€‹æ™è¦º (Take a nap)", "åšè¼•å¾®ä¼¸å±•æ”¾é¬†è‚Œè‚‰ (Gentle stretching)"],
                'confused': ["ç‡å“æ—¥æ›†ç¢ºèªæ—¥å­ (Check calendar)", "é£²æ¯æš–æ°´å®šé©š (Drink warm water)", "åä¿‚çª—é‚Šç‡é¢¨æ™¯ (Sit by window)"],
                'surprised': ["åä½æ·±å‘¼å¸ (Sit and breathe)", "é£²æ¯ç†±èŒ¶å£“é©š (Drink hot tea)", "æ‘¸å“å¯µç‰©å®šé©š (Pet an animal)"],
                'sick': ["ä¹–ä¹–åœ°é£Ÿè—¥ä¼‘æ¯ (Take meds and rest)", "å¤šé£²æš–æ°´ (Drink warm water)", "é‡å“è¡€å£“é«”æº« (Check vitals)"],
                'anxious': ["åš4-7-8å‘¼å¸æ³• (Deep breathing)", "æ¸ä½å€‹æš–æ°´è¢‹ (Hold a warm water bag)", "å”¸ä½›æˆ–è€…ç¥ˆç¦± (Praying)"],
                'sad': ["æ‰“é–‹çª—ç°¾æ›¬å¤ªé™½ (Let sunlight in)", "é£Ÿä»¶ç”œå“æ°¹è‡ªå·±é–‹å¿ƒ (Eat a treat)", "ç‡è¿”ä»¥å‰å˜…é–‹å¿ƒç›¸ (Look at happy photos)"],
                'angry': ["æ·±å‘¼å¸åä¸‹ (Deep breaths)", "æ¸å“å£“åŠ›æ³¢ (Squeeze stress ball)", "å»éœ²å°å¹å“é¢¨ (Fresh air)"],
                'frustrated': ["åœä¸€åœï¼Œé£²æ¯æ°´å…ˆ (Stop and drink water)", "æµäººå¹«æ‰‹ (Ask for help)", "è½æ”¶éŸ³æ©Ÿè½‰ç§»è¦–ç·š (Listen to radio)"]
            };

            // Get song list for the mood, or default to happy if undefined
            const moodSongs = songDatabase[mood] || songDatabase['happy'];
            const moodActivities = activityDatabase[mood] || activityDatabase['happy'];
            
            // Randomly select one song and one activity
            const song = moodSongs[Math.floor(Math.random() * moodSongs.length)];
            const activity = moodActivities[Math.floor(Math.random() * moodActivities.length)];
            
            const display = document.getElementById('mood-result');
            
            // Build the UI card for the song
            display.innerHTML = `
                <div class="flex flex-col gap-3">
                    <div class="text-lg text-purple-900 font-bold">${song.msg}</div>
                    
                    <!-- Activity Suggestion Card -->
                    <div class="bg-amber-50 border-2 border-amber-100 rounded-xl p-4 flex items-center gap-4 shadow-sm">
                        <div class="w-12 h-12 rounded-full bg-amber-400 text-white flex items-center justify-center flex-shrink-0 text-2xl shadow-md">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div>
                            <div class="text-xs text-amber-500 font-bold uppercase tracking-wider mb-1">Activity Idea (å»ºè­°æ´»å‹•)</div>
                            <div class="text-lg font-bold text-amber-900 leading-tight">${activity}</div>
                        </div>
                    </div>

                    <!-- Song Card -->
                    <div onclick="window.open('https://www.youtube.com/results?search_query=${encodeURIComponent(song.q)}', '_blank')" 
                         class="bg-red-50 border-2 border-red-100 rounded-xl p-4 flex items-center justify-between cursor-pointer hover:bg-red-100 transition-colors shadow-sm">
                        <div class="text-left flex-1">
                            <div class="text-xs text-red-400 font-bold uppercase tracking-wider mb-1">Classic Hit (é‡‘æ›²æ¨ä»‹)</div>
                            <div class="text-xl font-extrabold text-red-800 leading-tight">${song.t}</div>
                            <div class="text-md text-red-600 mt-1">${song.a}</div>
                        </div>
                        <div class="bg-red-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center flex-shrink-0 animate-bounce">
                            <i class="fab fa-youtube text-3xl pl-1"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 text-center">Tap to listen on YouTube (é»æ“Šæ”¶è½)</p>
                </div>
            `;
            
            // Speak the encouraging message (Cantonese)
            const speakMsg = `${song.msg} å»ºè­°ä½ å¯ä»¥ï¼š${activity}`;
            speakText('mood-advice', speakMsg);
        }


        // --- ADVANCED AUDIO / SPEECH PLAYER ---

        // 1. Unified Toggle Function
        function togglePlayback(id, textContent, type) {
            const state = window.AppState;

            // AUTO-LOOKUP: If text is missing (passed as null from HTML to avoid syntax errors), find it.
            if (type === 'tts' && !textContent) {
                const note = state.notes.find(n => n.id === id);
                if (note) {
                    textContent = note.summary;
                } else {
                    const med = state.medicineScans.find(m => m.id === id);
                    if (med) textContent = med.summary;
                }
            }

            // Scenario A: Toggling CURRENT item
            if (state.currentSpeechId === id && state.playerMode === type) {
                if (state.isPaused) {
                    // RESUME
                    state.isPaused = false;
                    
                    if (type === 'audio' && state.audioElem) {
                        state.audioElem.play();
                    } 
                    else if (type === 'tts') {
                        // RESUME TTS
                        if (window.speechSynthesis.paused) {
                            window.speechSynthesis.resume();
                        } else {
                            // If engine lost state, restart from last index
                            const resumeText = state.speechText ? state.speechText.substring(state.speechCharIndex) : textContent;
                            internalSpeak(resumeText, true); 
                        }
                    }
                    updatePlayerUI(id, true);
                } else {
                    // PAUSE
                    state.isPaused = true;
                    if (type === 'audio' && state.audioElem) state.audioElem.pause();
                    if (type === 'tts') {
                        window.speechSynthesis.cancel();
                    }
                    updatePlayerUI(id, false);
                }
                return;
            }

            // Scenario B: Playing NEW item
            stopAudio(); // Reset everything
            
            state.currentSpeechId = id;
            state.playerMode = type;
            state.isPaused = false;
            
            updatePlayerUI(id, true); // Set to playing state immediately

            if (type === 'audio') {
                // Find note audio
                const note = state.notes.find(n => n.id === id);
                if (note && note.audioBase64) {
                    const audio = new Audio(note.audioBase64);
                    state.audioElem = audio;
                    
                    audio.ontimeupdate = () => {
                         const pct = (audio.currentTime / audio.duration) * 100;
                         updateSliderVisuals(id, pct);
                    };
                    audio.onended = () => {
                        resetPlayerState();
                        updatePlayerUI(id, false, true); // Reset UI to start
                    };
                    audio.play();
                }
            } else {
                // TTS
                state.speechText = textContent;
                state.speechCharIndex = 0;
                internalSpeak(textContent, false);
            }
        }

        // 2. Internal Speak Helper (handles language & resume)
        function internalSpeak(textFragment, isResume) {
             if(!textFragment) return;
             
             // Language detection
             const isChinese = /[\u4e00-\u9fa5]/.test(textFragment);
             const voices = window.speechSynthesis.getVoices();
             let selectedVoice = null;
             
             if (isChinese) {
                // STRONG Priority for Cantonese (Hong Kong)
                // 1. Look for specific language codes
                // 2. Look for names containing Cantonese/HK
                // 3. Fallback to any Chinese
                selectedVoice = voices.find(v => v.lang === 'zh-HK' || v.lang === 'zh-yue') || 
                                voices.find(v => v.name.includes('Cantonese') || v.name.includes('Hong Kong') || v.name.includes('HK')) ||
                                voices.find(v => v.lang.includes('zh'));
            } else {
                selectedVoice = voices.find(v => v.lang.includes('en-US') && v.name.includes('Google')) ||
                                voices.find(v => v.lang.includes('en-US')) ||
                                voices[0];
            }

            const utterance = new SpeechSynthesisUtterance(textFragment);
            
            // EXPLICITLY set the language code. 
            // This ensures that even if 'selectedVoice' is null (e.g. voices haven't loaded yet), 
            // the system tries to use the correct default engine for that region.
            if (isChinese) {
                utterance.lang = 'zh-HK'; 
            } else {
                utterance.lang = 'en-US';
            }

            if(selectedVoice) utterance.voice = selectedVoice;
            
            // ADJUSTED FOR ELDERLY: Gentler and Friendlier
            utterance.rate = 0.85; // Slower speed for better clarity and patience
            utterance.pitch = 1.1; // Slightly higher pitch usually sounds friendlier and warmer

            const baseIndex = isResume ? window.AppState.speechCharIndex : 0;

            utterance.onboundary = (event) => {
                if(event.name === 'word') {
                     // Update global index based on where we started this specific fragment
                     window.AppState.speechCharIndex = baseIndex + event.charIndex;
                     
                     // Update UI
                     const totalLen = window.AppState.speechText.length;
                     const pct = (window.AppState.speechCharIndex / totalLen) * 100;
                     
                     // Only update visual if not dragging
                     if(!window.AppState.isDragging) {
                         updateSliderVisuals(window.AppState.currentSpeechId, pct);
                     }
                }
            };

            utterance.onend = () => {
                // If we reached the end naturally (not cancelled by pause/seek)
                if (!window.AppState.isPaused && !window.AppState.isDragging) {
                     // Check if actually finished (close enough to end)
                     if (window.AppState.speechCharIndex >= (window.AppState.speechText?.length || 0) - 10) {
                         resetPlayerState();
                         // Refresh active view to show stopped state
                         const activeView = document.querySelector('.view-section.active')?.id;
                         if(activeView === 'view-notes') renderNotes();
                         if(activeView === 'view-medicine') renderMeds();
                     }
                }
            };
            
            window.AppState.speechUtterance = utterance;
            window.speechSynthesis.speak(utterance);
        }

        // 3. Seek/Scrubbing Handler
        function handleSeek(id, val) {
            const state = window.AppState;
            
            // If dragging slider on a non-playing item, do nothing (or start it?)
            // We assume togglePlayback was called first usually. 
            // If dragging, we set flag to stop automatic updates fighting the user
            state.isDragging = true;
            
            // Visual Update immediately
            const slider = document.getElementById(`slider-${id}`);
            if(slider) {
                slider.style.background = `linear-gradient(to right, #ff0000 0%, #ff0000 ${val}%, #e2e8f0 ${val}%, #e2e8f0 100%)`;
            }

            // Debounce actual seek logic
            clearTimeout(window.seekTimeout);
            window.seekTimeout = setTimeout(() => {
                performSeek(id, val);
                state.isDragging = false;
            }, 300); // Wait 300ms after last drag event
        }

        function performSeek(id, percent) {
            const state = window.AppState;
            if (state.currentSpeechId !== id) return;

            if (state.playerMode === 'audio' && state.audioElem) {
                const newTime = (percent / 100) * state.audioElem.duration;
                state.audioElem.currentTime = newTime;
            } else if (state.playerMode === 'tts' && state.speechText) {
                // TTS Seek requires cancel + restart because native seek isn't standard
                window.speechSynthesis.cancel();
                
                // Calculate new index
                const totalLen = state.speechText.length;
                const newIndex = Math.floor((percent / 100) * totalLen);
                state.speechCharIndex = newIndex;
                
                // If currently playing (not paused), restart immediately
                if (!state.isPaused) {
                    const remaining = state.speechText.substring(newIndex);
                    internalSpeak(remaining, true);
                } 
                // If paused, we just updated the index. Resume button will handle the rest.
            }
        }

        // 4. Efficient UI Updater (Does not destroy DOM)
        function updatePlayerUI(id, isPlaying, reset = false) {
             const mode = window.AppState.playerMode;
             const status = document.getElementById(`status-${id}`);
             
             // Get Buttons
             const btnAudio = document.getElementById(`btn-audio-${id}`);
             const btnTTS = document.getElementById(`btn-tts-${id}`);
             // Meds button fallback
             const btnPlay = document.getElementById(`btn-play-${id}`);

             // RESET ALL
             if (reset) {
                 if(btnAudio) {
                     btnAudio.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-white text-gray-700 border border-gray-200 hover:bg-gray-50";
                     btnAudio.innerHTML = '<i class="fas fa-microphone-lines text-lg"></i> <span>éŒ„éŸ³</span>';
                 }
                 if(btnTTS) {
                     btnTTS.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-white text-gray-700 border border-gray-200 hover:bg-gray-50";
                     btnTTS.innerHTML = '<i class="fas fa-volume-high text-lg"></i> <span>æœ—è®€ç¸½çµ</span>';
                 }
                 if(btnPlay) {
                     // For meds view
                     const icon = btnPlay.querySelector('i');
                     if(icon) icon.className = 'fas fa-play text-xl';
                     btnPlay.classList.remove('animate-pulse');
                 }
                 
                 if(status) status.textContent = "æº–å‚™å°±ç·’";
                 updateSliderVisuals(id, 0);
                 return;
             }

             // UPDATE ACTIVE
             if (mode === 'audio' && btnAudio) {
                 if (isPlaying) {
                     btnAudio.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-red-500 text-white animate-pulse";
                     btnAudio.innerHTML = '<i class="fas fa-stop text-lg"></i> <span>éŒ„éŸ³</span>';
                     if(status) status.textContent = "æ’­æ”¾éŒ„éŸ³ä¸­...";
                 } else {
                     // Paused state style
                     btnAudio.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-red-100 text-red-600 border border-red-200";
                     btnAudio.innerHTML = '<i class="fas fa-play text-lg"></i> <span>ç¹¼çºŒ</span>';
                     if(status) status.textContent = "å·²æš«åœ";
                 }
                 // Reset the other button
                 if(btnTTS) {
                     btnTTS.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-white text-gray-700 border border-gray-200 hover:bg-gray-50";
                     btnTTS.innerHTML = '<i class="fas fa-volume-high text-lg"></i> <span>æœ—è®€ç¸½çµ</span>';
                 }
             }
             
             if (mode === 'tts' && btnTTS) {
                 if (isPlaying) {
                     btnTTS.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-blue-500 text-white animate-pulse";
                     btnTTS.innerHTML = '<i class="fas fa-stop text-lg"></i> <span>ç¸½çµ</span>';
                     if(status) status.textContent = "æœ—è®€ç¸½çµä¸­...";
                 } else {
                     btnTTS.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-blue-100 text-blue-600 border border-blue-200";
                     btnTTS.innerHTML = '<i class="fas fa-play text-lg"></i> <span>ç¹¼çºŒ</span>';
                     if(status) status.textContent = "å·²æš«åœ";
                 }
                 // Reset the other button
                 if(btnAudio) {
                     btnAudio.className = "flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-white text-gray-700 border border-gray-200 hover:bg-gray-50";
                     btnAudio.innerHTML = '<i class="fas fa-microphone-lines text-lg"></i> <span>éŒ„éŸ³</span>';
                 }
             }
             
             // Meds view handling
             if (btnPlay && !btnAudio && !btnTTS) {
                 const icon = btnPlay.querySelector('i');
                 if(isPlaying) {
                     icon.className = 'fas fa-pause text-xl';
                     btnPlay.classList.add('animate-pulse');
                     if(status) status.textContent = "æœ—è®€ä¸­...";
                 } else {
                     icon.className = 'fas fa-play text-xl';
                     btnPlay.classList.remove('animate-pulse');
                     if(status) status.textContent = "å·²æš«åœ";
                 }
             }
        }
        
        function updateSliderVisuals(id, pct) {
            const slider = document.getElementById(`slider-${id}`);
            if (slider) {
                slider.value = pct;
                // Update CSS gradient for "progress bar" fill effect behind the thumb
                slider.style.background = `linear-gradient(to right, #ff0000 0%, #ff0000 ${pct}%, #e2e8f0 ${pct}%, #e2e8f0 100%)`;
            }
        }
        
        // 5. Speak Text Wrapper (Legacy compatibility for other calls)
        function speakText(id, text) {
            // Just call togglePlayback logic
            // Note: id passed here might be generic like 'mood-advice' which isn't in a list.
            if (id === 'mood-advice' || id === 'scan-result') {
                window.speechSynthesis.cancel();
                window.AppState.playerMode = 'tts';
                window.AppState.speechText = text;
                window.AppState.speechCharIndex = 0;
                internalSpeak(text, false);
            } else {
                togglePlayback(id, text, 'tts');
            }
        }

        
        // GENERIC STOP
        function stopAudio() {
            // Cancel implies stop & clear buffer
            if (window.speechSynthesis.speaking || window.speechSynthesis.paused) {
                 window.speechSynthesis.cancel();
            }
            if (window.AppState.audioElem) {
                window.AppState.audioElem.pause();
                window.AppState.audioElem = null;
            }
            // If we were playing something, update its UI to stopped
            if (window.AppState.currentSpeechId) {
                updatePlayerUI(window.AppState.currentSpeechId, false, true);
            }
            resetPlayerState();
        }
        
        function resetPlayerState() {
            window.AppState.currentSpeechId = null;
            window.AppState.playerMode = null;
            window.AppState.speechText = null;
            window.AppState.speechUtterance = null;
            window.AppState.speechCharIndex = 0;
            window.AppState.isPaused = false;
        }
        
        // NOTES (Audio Recording)
        async function toggleRecord() {
            const btn = document.getElementById('record-btn');
            const txtBox = document.getElementById('notes-summary-output');
            const statusEl = document.getElementById('recording-status');
            
            if (window.AppState.isRecording) {
                // --- STOP ACTION ---
                window.AppState.isRecording = false; 

                // Stop Audio File Recorder
                if(window.AppState.mediaRecorder && window.AppState.mediaRecorder.state !== 'inactive') {
                    window.AppState.mediaRecorder.stop();
                }
                
                // Stop Speech Recognition (Kill the loop)
                if(window.AppState.recognition) {
                    window.AppState.recognition.onend = null; // Important: Remove listener to prevent auto-restart
                    window.AppState.recognition.stop();
                }
                
                // Close Audio Context (Save battery)
                if (window.AppState.audioCtx) {
                    window.AppState.audioCtx.suspend();
                }

                btn.innerHTML = '<i class="fas fa-microphone text-3xl"></i> é–‹å§‹éŒ„éŸ³';
                btn.classList.remove('bg-red-600', 'animate-pulse');
                btn.classList.add('btn-primary');
                
                // UI Cleanup
                txtBox.classList.remove('border-red-400', 'bg-red-50');
                if(statusEl) statusEl.textContent = "";
                
                // Auto Analyze after a short delay
                setTimeout(() => {
                    const currentText = txtBox.value.trim();
                    if (currentText.length > 5) {
                        analyzeNoteText();
                    }
                }, 800);
                
            } else {
                // --- START ACTION ---
                try {
                    // 0. AUDIO HARDWARE WARM-UP (Fixes "Missing first words")
                    if (!window.AppState.audioCtx) {
                        window.AppState.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (window.AppState.audioCtx.state === 'suspended') {
                        await window.AppState.audioCtx.resume();
                    }
                    // Play a tiny silent buffer to keep the audio path "hot"
                    const buffer = window.AppState.audioCtx.createBuffer(1, 1, 22050);
                    const node = window.AppState.audioCtx.createBufferSource();
                    node.buffer = buffer;
                    node.connect(window.AppState.audioCtx.destination);
                    node.start(0);

                    // 1. Get Mic Stream with High Accuracy Constraints
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            channelCount: 1, 
                            sampleRate: 44100
                        } 
                    });
                    
                    // 2. Audio Recorder (For the file)
                    window.AppState.mediaRecorder = new MediaRecorder(stream);
                    window.AppState.audioChunks = [];
                    window.AppState.mediaRecorder.ondataavailable = (e) => window.AppState.audioChunks.push(e.data);
                    window.AppState.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(window.AppState.audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => { window.AppState.currentAudioBase64 = reader.result; }
                        stream.getTracks().forEach(track => track.stop());
                    };
                    window.AppState.mediaRecorder.start();

                    // 3. Speech Recognition (Text)
                    if ('webkitSpeechRecognition' in window) {
                        window.AppState.isRecording = true;
                        
                        // SNAPSHOT: Lock in the current text as the "Anchor"
                        let currentVal = txtBox.value.trim();
                        // Add a space if there's previous text so new text doesn't mash into it
                        if(currentVal.length > 0 && !currentVal.endsWith('\n')) {
                            window.AppState.anchorText = currentVal + " ";
                        } else {
                            window.AppState.anchorText = currentVal;
                        }
                        
                        // Visuals
                        txtBox.classList.add('border-red-400', 'bg-red-50');
                        
                        // Start the improved loop
                        startSpeechLoop();
                        
                        document.getElementById('btn-analyze-note').classList.add('hidden'); 
                    } else {
                        alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ (è«‹å˜—è©¦ Chrome/Safari)ã€‚ä½†éŒ„éŸ³åŠŸèƒ½ä»å¯ä½¿ç”¨ã€‚");
                        window.AppState.isRecording = true;
                    }

                    // UI Updates
                    btn.innerHTML = '<i class="fas fa-stop text-3xl"></i> åœæ­¢éŒ„éŸ³';
                    btn.classList.remove('btn-primary'); 
                    btn.classList.add('bg-red-600', 'animate-pulse'); 
                    
                } catch (err) {
                    console.error(err);
                    alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚");
                }
            }
        }

        // NEW: "Full Session" Logic (Prevents Deleting Words)
        function startSpeechLoop() {
            if (!window.AppState.isRecording) return;

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = true; 
            recognition.interimResults = true;
            recognition.maxAlternatives = 1; 
            recognition.lang = document.getElementById('notes-lang-select').value;
            
            const statusEl = document.getElementById('recording-status');

            recognition.onstart = () => {
                if(statusEl && window.AppState.isRecording) statusEl.textContent = "è†è½ä¸­... ğŸ™ï¸";
            };

            recognition.onresult = (event) => {
                let currentSessionTranscript = "";

                // STABLE STRATEGY:
                // We do NOT use accumulatedText + finalized here. 
                // We simply take the entire transcript from the current session (event.results)
                // and append it to our "Anchor" (text before this session started).
                // This prevents the "disappearing words" issue caused by interim vs final mismatches.
                for (let i = 0; i < event.results.length; ++i) {
                    currentSessionTranscript += event.results[i][0].transcript;
                }
                
                const txtBox = document.getElementById('notes-summary-output');
                txtBox.value = window.AppState.anchorText + currentSessionTranscript;
                txtBox.scrollTop = txtBox.scrollHeight;
            };

            recognition.onend = () => {
                // Only restart if the user hasn't clicked Stop
                if (window.AppState.isRecording) {
                    if(statusEl) statusEl.textContent = "è™•ç†ä¸­... âš¡";
                    console.log("Browser stopped. Resyncing anchor and restarting...");
                    
                    // UPDATE ANCHOR:
                    // The session ended. The text in the box is now the new "Anchor".
                    const txtBox = document.getElementById('notes-summary-output');
                    let val = txtBox.value.trim();
                    if(val.length > 0) val += " ";
                    window.AppState.anchorText = val;
                    
                    // Restart immediately (10ms delay to clear stack)
                    setTimeout(startSpeechLoop, 10);
                } else {
                    if(statusEl) statusEl.textContent = "";
                }
            };

            recognition.onerror = (event) => {
                console.warn("Speech recognition error", event.error);
                if (event.error === 'not-allowed') {
                    window.AppState.isRecording = false;
                    const btn = document.getElementById('record-btn');
                    const txtBox = document.getElementById('notes-summary-output');
                    btn.innerHTML = '<i class="fas fa-microphone text-3xl"></i> é–‹å§‹éŒ„éŸ³';
                    btn.classList.remove('bg-red-600', 'animate-pulse');
                    btn.classList.add('btn-primary');
                    txtBox.classList.remove('border-red-400', 'bg-red-50');
                    if(statusEl) statusEl.textContent = "éº¥å…‹é¢¨è¢«å°é– ğŸš«";
                }
            };

            try {
                recognition.start();
                window.AppState.recognition = recognition;
            } catch(e) {
                console.error("Start failed", e);
                if(window.AppState.isRecording) setTimeout(startSpeechLoop, 100);
            }
        }

        // NEW: AI Analysis for Notes
        async function analyzeNoteText() {
            const rawText = document.getElementById('notes-summary-output').value;
            if (!rawText || rawText.length < 5) return;

            const statusEl = document.getElementById('note-analysis-status');
            const analyzeBtn = document.getElementById('btn-analyze-note');
            
            statusEl.classList.remove('hidden');
            analyzeBtn.classList.add('hidden');

            try {
                // IMPROVED PROMPT: Ask AI to fix accuracy issues first
                const prompt = `
                    You are a medical assistant for an elderly patient. 
                    The following text was transcribed from voice and may have accuracy errors.
                    
                    1. First, intelligently correct any obvious transcription errors in the raw text.
                    2. Then, summarize the corrected text strictly in **Traditional Chinese (Hong Kong Style / ç¹é«”ä¸­æ–‡)**.
                    
                    Raw Text: "${rawText}"
                    
                    Output Format in Traditional Chinese ONLY (No English headers):
                    1. **æ‘˜è¦**: (1 sentence overview using HK terminology)
                    2. **é‡é»**: (Bullet points of meds, symptoms, or doctor instructions)
                    3. **è·Ÿé€²**: (Any appointments or things to do)
                    
                    Keep it simple, warm, and easy to read.
                `;

                const aiSummary = await askServerAI(prompt);

                if (aiSummary) {
                    document.getElementById('notes-summary-output').value = aiSummary;
                } else {
                    throw new Error("No AI response");
                }

            } catch (e) {
                console.error("Analysis failed", e);
                analyzeBtn.classList.remove('hidden'); 
            } finally {
                statusEl.classList.add('hidden');
            }
        }

        // HELPER: Calculate rough size of object in bytes
        function getSizeInBytes(obj) {
            return new Blob([JSON.stringify(obj)]).size;
        }

        // UPDATED: Robust Save Note function (Handles Unlimited Audio)
        async function saveNote() {
            const location = document.getElementById('notes-input-location').value;
            const summary = document.getElementById('notes-summary-output').value;
            
            // 1. Handle Active Recording
            if (window.AppState.isRecording) {
                // Stop recording and wait a moment for audio processing to finish
                toggleRecord(); 
                await new Promise(resolve => setTimeout(resolve, 800)); // Wait for onstop event
            }

            const audio = window.AppState.currentAudioBase64;
            
            if (!location && !summary && !audio) {
                showAlert("è«‹éŒ„éŸ³æˆ–è¼¸å…¥åœ°é»ã€‚");
                return;
            }
            
            let note = {
                id: 'note_' + Date.now(),
                timestamp: Date.now(),
                location: location || "ä¸€èˆ¬ç­†è¨˜",
                summary: summary || "(èªéŸ³ç­†è¨˜)",
                audioBase64: audio || null
            };
            
            // 2. Check Size Limit (Firestore limit is ~1MB)
            const size = getSizeInBytes(note);
            // Limit to ~900KB to be safe
            if (size > 900000) {
                console.warn(`Note too large (${size} bytes). Dropping audio.`);
                note.audioBase64 = null; // Drop audio
                note.summary += "\n\n[ç³»çµ±: éŒ„éŸ³å¤ªé•·ï¼Œå·²å„²å­˜è‡³è£ç½®ï¼Œé›²ç«¯åƒ…ä¿ç•™æ–‡å­—]";
                window.showAlert("éŒ„éŸ³å¤ªé•·ï¼åƒ…å„²å­˜æ–‡å­—ã€‚");
            }
            
            // 3. Save
            try {
                await saveItem('elder_notes', note);
                
                // Reset UI
                document.getElementById('notes-input-location').value = '';
                document.getElementById('notes-summary-output').value = '';
                const analyzeBtn = document.getElementById('btn-analyze-note');
                if(analyzeBtn) analyzeBtn.classList.add('hidden');
                
                window.AppState.currentAudioBase64 = null;
                window.AppState.sessionTranscript = ""; 
                window.AppState.preExistingText = "";
                window.AppState.accumulatedText = "";
                window.AppState.currentSessionText = "";
                
                window.showAlert("ç­†è¨˜å·²å„²å­˜ï¼");
            } catch(e) {
                console.error(e);
                // Alert is handled in saveItem, but fallback just in case
                if(e.code === 'resource-exhausted') {
                    window.showAlert("å„²å­˜ç©ºé–“ä¸è¶³æˆ–æª”æ¡ˆå¤ªå¤§ã€‚");
                }
            }
        }

        function playNoteAudio(id) {
           // Legacy redirect to new system
           togglePlayback(id, null, 'audio');
        }

        // CAMERA / SCANNER LOGIC
        async function startCam(type) {
            window.AppState.scanningType = type; // 'label' or 'appearance'
            const container = document.getElementById('video-container');
            const video = document.getElementById('video-feed');
            
            // Ensure status is hidden when starting new scan
            document.getElementById('scan-status').classList.add('hidden');

            container.classList.remove('hidden');
            document.getElementById('start-camera-btn').classList.add('hidden');
            document.getElementById('capture-btn').classList.remove('hidden');
            document.getElementById('capture-btn').classList.add('flex'); // ensure flex
            
            // Update overlay text
            document.getElementById('scan-instruction-text').textContent = type === 'label' ? "æƒææ¨™ç±¤" : "æƒæè—¥ä¸¸/è—¥ç“¶";

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error(err);
                alert("ç›¸æ©ŸéŒ¯èª¤ã€‚è«‹å…è¨±å­˜å–æ¬Šé™ã€‚");
            }
        }

        function captureScan() {
            const video = document.getElementById('video-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            // Stop stream
            const stream = video.srcObject;
            if(stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('video-container').classList.add('hidden');
            document.getElementById('capture-btn').classList.add('hidden');
            document.getElementById('start-camera-btn').classList.remove('hidden'); // Show start button again
            
            const scanStatus = document.getElementById('scan-status');
            
            // Save to state and update preview UI
            if (window.AppState.scanningType === 'label') {
                window.AppState.currentLabelImg = dataUrl;
                document.getElementById('preview-label').innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
                
                // AUTO FLOW: Switch to Appearance
                // Only auto-switch if we don't have the appearance image yet
                if (!window.AppState.currentAppearanceImg) {
                    scanStatus.innerHTML = '<i class="fas fa-check-circle text-green-600"></i> å·²æ‹æ”æ¨™ç±¤ï¼è½‰è‡³æ‹æ”è—¥ä¸¸...';
                    scanStatus.classList.remove('hidden');
                    
                    setTimeout(() => {
                         scanStatus.classList.add('hidden');
                         startCam('appearance');
                    }, 2000);
                }
            } else {
                window.AppState.currentAppearanceImg = dataUrl;
                document.getElementById('preview-appearance').innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
                
                // AUTO FLOW: Analyze
                // Only auto-analyze if we have the label
                if (window.AppState.currentLabelImg) {
                    scanStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ†æå½±åƒä¸­...';
                    scanStatus.classList.remove('hidden');
                    analyzeDualImages();
                }
            }
            
            // Show Analyze button if manual intervention is needed later
            if (window.AppState.currentLabelImg || window.AppState.currentAppearanceImg) {
                document.getElementById('analyze-btn').classList.remove('hidden');
            }
        }
        
        async function analyzeDualImages() {
             const labelImg = window.AppState.currentLabelImg;
             const appearanceImg = window.AppState.currentAppearanceImg;
             
             if (!labelImg && !appearanceImg) {
                 showAlert("è«‹è‡³å°‘æƒæä¸€å¼µåœ–ç‰‡ã€‚");
                 return;
             }
             
             document.getElementById('scan-status').classList.remove('hidden');
             document.getElementById('analyze-btn').classList.add('hidden');
             
             try {
                // Construct Prompt
                let prompt = "Analyze these images for an elderly patient. Provide the explanation strictly in Traditional Chinese (ç¹é«”ä¸­æ–‡). ";
                const images = [];
                
                if (labelImg) {
                    prompt += "Image 1 is the medicine label/text. Extract the name and dosage. ";
                    images.push({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: labelImg.split(',')[1]
                        }
                    });
                }
                if (appearanceImg) {
                     prompt += "Image 2 is the physical appearance (pill/bottle). Describe color/shape. ";
                     images.push({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: appearanceImg.split(',')[1]
                        }
                    });
                }
                
                prompt += "OUTPUT FORMAT: First line: Medicine Name (keep original name). Next paragraph: Simple, friendly explanation in Traditional Chinese (Hong Kong Style / ç¹é«”ä¸­æ–‡) ONLY. Do not use English words. Explain what it is for and one key safety tip. Keep it short.";

                // --- CHANGE STARTS HERE ---
                
                // Call the bridge instead of fetch
                const text = await askServerAI(prompt, imgToSend);
                
                // --- CHANGE ENDS HERE ---
                
                // Parse rudimentary (First line name, rest summary)
                const lines = text.split('\n');
                const name = lines[0].replace(/\*/g, '').trim();
                const summary = lines.slice(1).join('\n').trim();
                
                document.getElementById('ocr-output').value = name;
                document.getElementById('ocr-summary-output').value = summary;
                document.getElementById('scan-status').classList.add('hidden');
                
                // Removed Auto-read call here. User must save then click "Listen" manually.

             } catch (e) {
                 console.error(e);
                 document.getElementById('scan-status').textContent = "é€£æ¥ AI éŒ¯èª¤";
             }
        }

        async function saveScan() {
            const name = document.getElementById('ocr-output').value;
            const summary = document.getElementById('ocr-summary-output').value;
            
            if(!name) { showAlert("æœªåµæ¸¬åˆ°è—¥ç‰©åç¨±ã€‚"); return; }
            
            const item = {
                id: 'med_' + Date.now(),
                timestamp: Date.now(),
                ocrText: name,
                summary: summary,
                labelImage: window.AppState.currentLabelImg, // Base64
                appearanceImage: window.AppState.currentAppearanceImg
            };
            
            await saveItem('medicine_scans', item);
            clearScan();
            showAlert("è—¥ç‰©å·²å„²å­˜ï¼");
        }

        function clearScan() {
            window.AppState.currentLabelImg = null;
            window.AppState.currentAppearanceImg = null;
            document.getElementById('preview-label').innerHTML = `<span class="text-gray-400 font-bold text-center p-2"><i class="fas fa-file-alt text-3xl mb-1 block"></i>æ¨™ç±¤</span>`;
            document.getElementById('preview-appearance').innerHTML = `<span class="text-gray-400 font-bold text-center p-2"><i class="fas fa-pills text-3xl mb-1 block"></i>è—¥ä¸¸/å¤–è§€</span>`;
            document.getElementById('ocr-output').value = '';
            document.getElementById('ocr-summary-output').value = '';
            document.getElementById('analyze-btn').classList.add('hidden');
        }

        // CONTACTS
        async function addContact() {
            const id = window.AppState.editingContactId || 'contact_' + Date.now();
            const name = document.getElementById('c-name').value;
            const role = document.getElementById('c-role').value;
            const phone = document.getElementById('c-phone').value;
            
            if(!name || !phone) { showAlert("å¿…é ˆè¼¸å…¥å§“ååŠé›»è©±ã€‚"); return; }
            
            await saveItem('medical_contacts', { id, name, role, phone });
            
            // Reset
            document.getElementById('c-name').value = '';
            document.getElementById('c-role').value = '';
            document.getElementById('c-phone').value = '';
            window.AppState.editingContactId = null;
            document.getElementById('btn-save-contact').textContent = "æ–°å¢è¯çµ¡äºº";
            document.getElementById('btn-cancel-contact').classList.add('hidden');
        }
        
        function editContact(id) {
            const c = window.AppState.contacts.find(x => x.id === id);
            if(!c) return;
            document.getElementById('c-name').value = c.name;
            document.getElementById('c-role').value = c.role;
            document.getElementById('c-phone').value = c.phone;
            window.AppState.editingContactId = id;
            document.getElementById('btn-save-contact').textContent = "æ›´æ–°";
            document.getElementById('btn-cancel-contact').classList.remove('hidden');
            window.scrollTo(0,0);
        }
        
        function cancelEditContact() {
            document.getElementById('c-name').value = '';
            document.getElementById('c-role').value = '';
            document.getElementById('c-phone').value = '';
            window.AppState.editingContactId = null;
            document.getElementById('btn-save-contact').textContent = "æ–°å¢è¯çµ¡äºº";
            document.getElementById('btn-cancel-contact').classList.add('hidden');
        }

        // REMINDERS
        async function addReminder() {
            const name = document.getElementById('r-name').value;
            const date = document.getElementById('r-date').value;
            const time = document.getElementById('r-time').value;
            
            if(!name || !date || !time) { showAlert("å¿…é ˆè¼¸å…¥äº‹é …ã€æ—¥æœŸåŠæ™‚é–“ã€‚"); return; }
            
            await saveItem('medication_reminders', { 
                id: 'rem_' + Date.now(),
                name, date, time, active: true
            });
            
            document.getElementById('r-name').value = '';
            document.getElementById('r-date').value = '';
            document.getElementById('r-time').value = '';
        }

        // NEW: Voice Input for Reminder
        function toggleReminderRecord() {
            const btn = document.getElementById('btn-record-reminder');
            const input = document.getElementById('r-name');
            
            if (window.AppState.isReminderRecording) {
                // STOP
                if (window.AppState.reminderRecognition) {
                    window.AppState.reminderRecognition.stop();
                }
                window.AppState.isReminderRecording = false;
                
                // Clear any pending silence timer
                if (window.AppState.reminderSilenceTimer) {
                    clearTimeout(window.AppState.reminderSilenceTimer);
                    window.AppState.reminderSilenceTimer = null;
                }
                
                btn.classList.remove('bg-red-600', 'animate-pulse', 'border-red-700');
                btn.classList.add('bg-indigo-500', 'border-indigo-600');
                btn.innerHTML = '<i class="fas fa-microphone text-5xl text-black"></i>';
                
            } else {
                // START
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = true; 
                    recognition.interimResults = true;
                    recognition.lang = 'zh-HK'; // Default to Cantonese
                    
                    recognition.onstart = () => {
                        window.AppState.isReminderRecording = true;
                        btn.classList.remove('bg-indigo-500', 'border-indigo-600');
                        btn.classList.add('bg-red-600', 'animate-pulse', 'border-red-700');
                        btn.innerHTML = '<i class="fas fa-stop text-5xl text-white"></i>';
                        input.placeholder = "è†è½ä¸­...";
                        input.value = ""; 
                    };

                    recognition.onresult = (event) => {
                        // 1. Clear existing timer because user is still speaking
                        if (window.AppState.reminderSilenceTimer) {
                            clearTimeout(window.AppState.reminderSilenceTimer);
                        }

                        // 2. Update Input Box
                        let transcript = '';
                        for (let i = 0; i < event.results.length; ++i) {
                            transcript += event.results[i][0].transcript;
                        }
                        input.value = transcript;

                        // 3. Set new 1-second silence timer
                        window.AppState.reminderSilenceTimer = setTimeout(() => {
                            if (window.AppState.isReminderRecording) {
                                console.log("1 second silence detected. Stopping reminder recording.");
                                recognition.stop();
                            }
                        }, 1000);
                    };

                    recognition.onend = () => {
                        window.AppState.isReminderRecording = false;
                        if (window.AppState.reminderSilenceTimer) {
                            clearTimeout(window.AppState.reminderSilenceTimer);
                        }

                        btn.classList.remove('bg-red-600', 'animate-pulse', 'border-red-700');
                        btn.classList.add('bg-indigo-500', 'border-indigo-600');
                        btn.innerHTML = '<i class="fas fa-microphone text-5xl text-black"></i>';
                        // Keep value if exists
                        if(!input.value) input.placeholder = "äº‹é …";
                    };
                    
                    recognition.onerror = (event) => {
                        console.error("Reminder speech error", event.error);
                        window.AppState.isReminderRecording = false;
                        if (window.AppState.reminderSilenceTimer) clearTimeout(window.AppState.reminderSilenceTimer);
                    };

                    recognition.start();
                    window.AppState.reminderRecognition = recognition;
                } else {
                    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ã€‚");
                }
            }
        }
        
        function addToCalendar(title, dateStr, timeStr) {
            if (!dateStr || !timeStr) {
                alert("å¿…é ˆè¼¸å…¥æ—¥æœŸåŠæ™‚é–“ã€‚");
                return;
            }

            const [year, month, day] = dateStr.split('-');
            const [hours, minutes] = timeStr.split(':');
            
            // Format for Google Calendar: YYYYMMDDTHHMMSS
            const pad = (n) => n.toString().padStart(2, '0');
            
            // Construct start/end objects to handle day rollover correctly
            // Month is 0-indexed in JS Date
            const startDate = new Date(year, month - 1, day, hours, minutes);
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // Default duration 1 hour
            
            // Format start string
            const startY = startDate.getFullYear();
            const startM = pad(startDate.getMonth() + 1);
            const startD = pad(startDate.getDate());
            const startH = pad(startDate.getHours());
            const startMin = pad(startDate.getMinutes());
            
            // Format end string
            const endY = endDate.getFullYear();
            const endM = pad(endDate.getMonth() + 1);
            const endD = pad(endDate.getDate());
            const endH = pad(endDate.getHours());
            const endMin = pad(endDate.getMinutes());
            
            const startDateTime = `${startY}${startM}${startD}T${startH}${startMin}00`;
            const endDateTime = `${endY}${endM}${endD}T${endH}${endMin}00`;
            
            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDateTime}/${endDateTime}&details=Added via Care Assistant`;
            
            window.open(url, '_blank');
        }

        // TRANSPORT
        function openTransport() {
            const dest = document.getElementById('transport-dest').value;
            const start = document.getElementById('transport-start').value;
            
            if (!dest) {
                showAlert("è«‹è¼¸å…¥ç›®çš„åœ°ã€‚");
                return;
            }

            let url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=transit`;
            
            // If start location is provided, add it to the URL
            if (start && start.trim() !== "") {
                url += `&origin=${encodeURIComponent(start)}`;
            }
            
            // Open Google Maps transit
            window.open(url, '_blank');
        }
        
        function callTaxi() {
             window.location.href = 'tel:27600455';
        }
        
        // NEW: Voice Input for Transport START
        function toggleTransportStartRecord() {
            const btn = document.getElementById('btn-record-transport-start');
            const input = document.getElementById('transport-start');
            
            if (window.AppState.isTransportStartRecording) {
                // STOP
                if (window.AppState.transportStartRecognition) {
                    window.AppState.transportStartRecognition.stop();
                }
                window.AppState.isTransportStartRecording = false;
                
                if (window.AppState.transportStartSilenceTimer) {
                    clearTimeout(window.AppState.transportStartSilenceTimer);
                    window.AppState.transportStartSilenceTimer = null;
                }
                
                btn.classList.remove('bg-red-600', 'animate-pulse', 'border-red-700');
                btn.classList.add('bg-amber-500', 'border-amber-600');
                btn.innerHTML = '<i class="fas fa-microphone text-5xl"></i>';
                
            } else {
                // START
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = true; 
                    recognition.interimResults = true;
                    recognition.lang = 'zh-HK'; 
                    
                    recognition.onstart = () => {
                        window.AppState.isTransportStartRecording = true;
                        btn.classList.remove('bg-amber-500', 'border-amber-600');
                        btn.classList.add('bg-red-600', 'animate-pulse', 'border-red-700');
                        btn.innerHTML = '<i class="fas fa-stop text-5xl"></i>';
                        input.placeholder = "è†è½ä¸­...";
                        input.value = ""; 
                    };

                    recognition.onresult = (event) => {
                        if (window.AppState.transportStartSilenceTimer) {
                            clearTimeout(window.AppState.transportStartSilenceTimer);
                        }

                        let transcript = '';
                        for (let i = 0; i < event.results.length; ++i) {
                            transcript += event.results[i][0].transcript;
                        }
                        input.value = transcript;

                        window.AppState.transportStartSilenceTimer = setTimeout(() => {
                            if (window.AppState.isTransportStartRecording) {
                                recognition.stop();
                            }
                        }, 1000);
                    };

                    recognition.onend = () => {
                        window.AppState.isTransportStartRecording = false;
                        if (window.AppState.transportStartSilenceTimer) {
                            clearTimeout(window.AppState.transportStartSilenceTimer);
                        }

                        btn.classList.remove('bg-red-600', 'animate-pulse', 'border-red-700');
                        btn.classList.add('bg-amber-500', 'border-amber-600');
                        btn.innerHTML = '<i class="fas fa-microphone text-5xl"></i>';
                        if(!input.value) input.placeholder = "å‡ºç™¼åœ°";
                    };
                    
                    recognition.onerror = (event) => {
                        console.error("Transport start speech error", event.error);
                        window.AppState.isTransportStartRecording = false;
                        if (window.AppState.transportStartSilenceTimer) clearTimeout(window.AppState.transportStartSilenceTimer);
                    };

                    recognition.start();
                    window.AppState.transportStartRecognition = recognition;
                } else {
                    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ã€‚");
                }
            }
        }

        // NEW: Voice Input for Transport DESTINATION
        function toggleTransportRecord() {
            const btn = document.getElementById('btn-record-transport');
            const input = document.getElementById('transport-dest');
            
            if (window.AppState.isTransportRecording) {
                // STOP
                if (window.AppState.transportRecognition) {
                    window.AppState.transportRecognition.stop();
                }
                window.AppState.isTransportRecording = false;
                
                // Clear any pending silence timer
                if (window.AppState.transportSilenceTimer) {
                    clearTimeout(window.AppState.transportSilenceTimer);
                    window.AppState.transportSilenceTimer = null;
                }
                
                btn.classList.remove('bg-red-600', 'animate-pulse', 'border-red-700');
                btn.classList.add('bg-amber-500', 'border-amber-600');
                btn.innerHTML = '<i class="fas fa-microphone text-5xl"></i>';
                
            } else {
                // START
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    // We use continuous=true so we can control the stop time manually (1 second silence)
                    recognition.continuous = true; 
                    recognition.interimResults = true;
                    recognition.lang = 'zh-HK'; // Default to Cantonese
                    
                    recognition.onstart = () => {
                        window.AppState.isTransportRecording = true;
                        btn.classList.remove('bg-amber-500', 'border-amber-600');
                        btn.classList.add('bg-red-600', 'animate-pulse', 'border-red-700');
                        // Updated to text-lg (smaller icon)
                        btn.innerHTML = '<i class="fas fa-stop text-5xl"></i>';
                        input.placeholder = "è†è½ä¸­...";
                        input.value = ""; // Clear previous input on new recording start
                    };

                    recognition.onresult = (event) => {
                        // 1. Clear existing timer because user is still speaking
                        if (window.AppState.transportSilenceTimer) {
                            clearTimeout(window.AppState.transportSilenceTimer);
                        }

                        // 2. Update Input Box
                        let transcript = '';
                        for (let i = 0; i < event.results.length; ++i) {
                            transcript += event.results[i][0].transcript;
                        }
                        input.value = transcript;

                        // 3. Set new 1-second silence timer
                        window.AppState.transportSilenceTimer = setTimeout(() => {
                            if (window.AppState.isTransportRecording) {
                                console.log("1 second silence detected. Stopping transport recording.");
                                recognition.stop();
                            }
                        }, 1000);
                    };

                    recognition.onend = () => {
                        window.AppState.isTransportRecording = false;
                        if (window.AppState.transportSilenceTimer) {
                            clearTimeout(window.AppState.transportSilenceTimer);
                        }

                        btn.classList.remove('bg-red-600', 'animate-pulse', 'border-red-700');
                        btn.classList.add('bg-amber-500', 'border-amber-600');
                        btn.innerHTML = '<i class="fas fa-microphone text-5xl"></i>';
                        // Keep value if exists
                        if(!input.value) input.placeholder = "ç›®çš„åœ°";
                    };
                    
                    recognition.onerror = (event) => {
                        console.error("Transport speech error", event.error);
                        // Silent fail is better for UI, just reset state
                        window.AppState.isTransportRecording = false;
                        if (window.AppState.transportSilenceTimer) clearTimeout(window.AppState.transportSilenceTimer);
                    };

                    recognition.start();
                    window.AppState.transportRecognition = recognition;
                } else {
                    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ã€‚");
                }
            }
        }

        // DELETION FLOW
        let deleteTarget = null;
        function confirmDelete(coll, id) {
            deleteTarget = { coll, id };
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function confirmClearDraft() {
            deleteTarget = 'draft_note';
            document.getElementById('confirm-modal').classList.remove('hidden');
        }
        
        async function executeDelete() {
            // 1. Hide modal immediately for instant feedback
            document.getElementById('confirm-modal').classList.add('hidden');
            
            const target = deleteTarget; // Capture target locally
            deleteTarget = null; // Reset global state

            // Handle Draft Clearing
            if (target === 'draft_note') {
                if (window.AppState.isRecording) {
                    // Manually stop recording state immediately
                    window.AppState.isRecording = false;
                    
                    if(window.AppState.mediaRecorder && window.AppState.mediaRecorder.state !== 'inactive') {
                        window.AppState.mediaRecorder.stop();
                    }
                    if(window.AppState.recognition) {
                        window.AppState.recognition.stop();
                    }
                    
                    // Reset Record Button UI
                    const btn = document.getElementById('record-btn');
                    if(btn) {
                        btn.innerHTML = '<i class="fas fa-microphone text-3xl"></i> é–‹å§‹éŒ„éŸ³';
                        btn.classList.remove('bg-red-600', 'animate-pulse');
                        btn.classList.add('btn-primary');
                    }
                }
                
                // Clear Input Fields
                document.getElementById('notes-input-location').value = '';
                document.getElementById('notes-summary-output').value = '';
                
                // Hide Analysis UI elements
                document.getElementById('btn-analyze-note').classList.add('hidden');
                const statusEl = document.getElementById('note-analysis-status');
                if(statusEl) statusEl.classList.add('hidden');
                
                // Reset Internal Buffers
                window.AppState.currentAudioBase64 = null;
                window.AppState.audioChunks = [];
                window.AppState.sessionTranscript = "";
                window.AppState.preExistingText = "";
                window.AppState.accumulatedText = ""; 
                window.AppState.currentSessionText = "";
                
                return;
            }

            // Handle Database Item Deletion
            if(target && typeof target === 'object') {
                // The modal is already hidden, so this happens in the background from user perspective
                await deleteItem(target.coll, target.id);
            }
        }

        // UTILS
        function showAlert(msg) {
            const el = document.getElementById('alert-msg');
            if(el) el.textContent = msg;
            const modal = document.getElementById('alert-modal');
            if(modal) modal.classList.remove('hidden');
            else alert(msg);
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        }
        
        // EXPLICITLY ASSIGNING FUNCTIONS TO WINDOW TO FIX REFERENCE ERRORS
        window.toggleRecord = toggleRecord;
        window.saveNote = saveNote;
        window.analyzeNoteText = analyzeNoteText;
        window.confirmClearDraft = confirmClearDraft;
        window.startCam = startCam;
        window.captureScan = captureScan;
        window.analyzeDualImages = analyzeDualImages;
        window.saveScan = saveScan;
        window.clearScan = clearScan;
        window.addContact = addContact;
        window.editContact = editContact;
        window.cancelEditContact = cancelEditContact;
        window.addReminder = addReminder;
        window.openTransport = openTransport;
        window.callTaxi = callTaxi;
        window.toggleTransportRecord = toggleTransportRecord;
        window.toggleTransportStartRecord = toggleTransportStartRecord;
        window.toggleReminderRecord = toggleReminderRecord;
        window.addToCalendar = addToCalendar;
        window.confirmDelete = confirmDelete;
        window.executeDelete = executeDelete;
        window.togglePlayback = togglePlayback;
        window.handleSeek = handleSeek;
        window.switchTab = switchTab;
        window.showAlert = showAlert;
        window.closeModal = closeModal;
        window.getMoodTip = getMoodTip;

        // Ensure DOM is ready before initApp called to prevent "innerHTML of null" errors
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initApp();
                // Register SW if browser supports it
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('Service Worker Registered'))
                    .catch(err => console.error('SW Fail', err));
                }
            });
        } else {
            initApp();
        }
    </script>
</body>
</html>
